<!doctype html>
<html
  dir="ltr"
  lang="zh-cn"
  data-theme=""
  
    class="html theme--light"
  
><head>
  <meta charset="utf-8" />
  <title>
    
      
        iris-go框架构建登陆api项目开发详解 |
      Snowlyg

  </title>

  <meta name="generator" content="Hugo 0.129.0"><meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <meta name="author" content="Snowlyg" />
  <meta
    name="description"
    content="简单的介绍iris-go框架构建登陆api后台项目的过程"
  />
  
  
    
    
    <link
      rel="stylesheet"
      href="/scss/main.min.8d4fad7e6916ad2e291e8d97ada157c70350d6d7150fea137e7243340967befb.css"
      integrity="sha256-jU&#43;tfmkWrS4pHo2XraFXxwNQ1tcVD&#43;oTfnJDNAlnvvs="
      crossorigin="anonymous"
      type="text/css"
    />
  

  
  <link
    rel="stylesheet"
    href="/css/markupHighlight.min.73ccfdf28df555e11009c13c20ced067af3cb021504cba43644c705930428b00.css"
    integrity="sha256-c8z98o31VeEQCcE8IM7QZ688sCFQTLpDZExwWTBCiwA="
    crossorigin="anonymous"
    type="text/css"
  />
  
  
  <link
    rel="stylesheet"
    href="/fontawesome/css/fontawesome.min.137b1cf3cea9a8adb7884343a9a5ddddf4280f59153f74dc782fb7f7bf0d0519.css"
    integrity="sha256-E3sc886pqK23iENDqaXd3fQoD1kVP3TceC&#43;3978NBRk="
    crossorigin="anonymous"
    type="text/css"
  />
  
  <link
    rel="stylesheet"
    href="/fontawesome/css/solid.min.e65dc5b48fb5f39b142360c57c3a215744c94e56c755c929cc3e88fe12aab4d3.css"
    integrity="sha256-5l3FtI&#43;185sUI2DFfDohV0TJTlbHVckpzD6I/hKqtNM="
    crossorigin="anonymous"
    type="text/css"
  />
  
  <link
    rel="stylesheet"
    href="/fontawesome/css/regular.min.6f4f16d58da1c82c0c3a3436e021a3d39b4742f741192c546e73e947eacfd92f.css"
    integrity="sha256-b08W1Y2hyCwMOjQ24CGj05tHQvdBGSxUbnPpR&#43;rP2S8="
    crossorigin="anonymous"
    type="text/css"
  />
  
  <link
    rel="stylesheet"
    href="/fontawesome/css/brands.min.e10425ad768bc98ff1fb272a0ac8420f9d1ba22f0612c08ff1010c95080ffe7e.css"
    integrity="sha256-4QQlrXaLyY/x&#43;ycqCshCD50boi8GEsCP8QEMlQgP/n4="
    crossorigin="anonymous"
    type="text/css"
  />
  
  <link rel="shortcut icon" href="/favicons/favicon.ico" type="image/x-icon" />
  <link rel="apple-touch-icon" sizes="180x180" href="/favicons/apple-touch-icon.png" />
  <link rel="icon" type="image/png" sizes="32x32" href="/favicons/favicon-32x32.png" />
  <link rel="icon" type="image/png" sizes="16x16" href="/favicons/favicon-16x16.png" />

  <link rel="canonical" href="https://snowlyg.github.io/posts/iris-go-api-1/" />

  
  
  
  
  <script
    type="text/javascript"
    src="/js/anatole-header.min.f9132794301a01ff16550ed66763482bd848f62243d278f5e550229a158bfd32.js"
    integrity="sha256-&#43;RMnlDAaAf8WVQ7WZ2NIK9hI9iJD0nj15VAimhWL/TI="
    crossorigin="anonymous"
  ></script>

  
    
    
    <script
      type="text/javascript"
      src="/js/anatole-theme-switcher.min.d6d329d93844b162e8bed1e915619625ca91687952177552b9b3e211014a2957.js"
      integrity="sha256-1tMp2ThEsWLovtHpFWGWJcqRaHlSF3VSubPiEQFKKVc="
      crossorigin="anonymous"
    ></script>
  

  

  


  
  
  <meta name="twitter:card" content="summary_large_image">
  <meta name="twitter:image" content="https://snowlyg.github.io/posts/iris-go-api-1/featured-image.jpg">
  <meta name="twitter:title" content="iris-go框架构建登陆api项目开发详解">
  <meta name="twitter:description" content="简单的介绍iris-go框架构建登陆api后台项目的过程">



  
  <meta property="og:url" content="https://snowlyg.github.io/posts/iris-go-api-1/">
  <meta property="og:site_name" content="Snowlyg&#39;s Blog">
  <meta property="og:title" content="iris-go框架构建登陆api项目开发详解">
  <meta property="og:description" content="简单的介绍iris-go框架构建登陆api后台项目的过程">
  <meta property="og:locale" content="zh_cn">
  <meta property="og:type" content="article">
    <meta property="article:section" content="posts">
    <meta property="article:published_time" content="2021-03-06T16:33:37+08:00">
    <meta property="article:modified_time" content="2021-03-06T16:33:37+08:00">
    <meta property="article:tag" content="Golang">
    <meta property="article:tag" content="IRIS">
    <meta property="article:tag" content="Api">
    <meta property="og:image" content="https://snowlyg.github.io/posts/iris-go-api-1/featured-image.jpg">



  
  
  
  
  <script type="application/ld+json">
    {
        "@context": "http://schema.org",
        "@type": "BlogPosting",
        "articleSection": "posts",
        "name": "iris-go框架构建登陆api项目开发详解",
        "headline": "iris-go框架构建登陆api项目开发详解",
        "alternativeHeadline": "",
        "description": "
      简单的介绍iris-go框架构建登陆api后台项目的过程


    ",
        "inLanguage": "zh-cn",
        "isFamilyFriendly": "true",
        "mainEntityOfPage": {
            "@type": "WebPage",
            "@id": "https:\/\/snowlyg.github.io\/posts\/iris-go-api-1\/"
        },
        "author" : {
            "@type": "Person",
            "name": "Snowlyg"
        },
        "creator" : {
            "@type": "Person",
            "name": "Snowlyg"
        },
        "accountablePerson" : {
            "@type": "Person",
            "name": "Snowlyg"
        },
        "copyrightHolder" : {
            "@type": "Person",
            "name": "Snowlyg"
        },
        "copyrightYear" : "2021",
        "dateCreated": "2021-03-06T16:33:37.00Z",
        "datePublished": "2021-03-06T16:33:37.00Z",
        "dateModified": "2021-03-06T16:33:37.00Z",
        "publisher":{
            "@type":"Organization",
            "name": "Snowlyg",
            "url": "https://snowlyg.github.io/",
            "logo": {
                "@type": "ImageObject",
                "url": "https:\/\/snowlyg.github.io\/favicons\/favicon-32x32.png",
                "width":"32",
                "height":"32"
            }
        },
        "image": 
      [
        
        "https://snowlyg.github.io/images/site-feature-image.png"


      
      ]

    ,
        "url" : "https:\/\/snowlyg.github.io\/posts\/iris-go-api-1\/",
        "wordCount" : "4120",
        "genre" : [ 
      
      "Golang"

    
      
        ,

      
      "IRIS"

    ],
        "keywords" : [ 
      
      "Golang"

    
      
        ,

      
      "IRIS"

    
      
        ,

      
      "Api"

    ]
    }
  </script>


</head>
<body class="body">
    <div class="wrapper">
      <aside
        
          class="wrapper__sidebar"
        
      ><div
  class="sidebar
    animated fadeInDown
  "
>
  <div class="sidebar__content">
    <div class="sidebar__introduction">
      <img
        class="sidebar__introduction-profileimage"
        src="https://avatars.githubusercontent.com/u/45998760?v=4"
        alt="profile picture"
      />
      
        <div class="sidebar__introduction-title">
          <a href="/">I&#39;m Snowlyg</a>
        </div>
      
      <div class="sidebar__introduction-description">
        <p>努力决定一切，不向命运屈服</p>
      </div>
    </div>
    <ul class="sidebar__list">
      
        <li class="sidebar__list-item">
          <a
            href="https://www.linkedin.com/in/dan-luo-3704a21a4/"
            target="_blank"
            rel="noopener me"
            aria-label="Linkedin"
            title="Linkedin"
          >
            <i class="fa-brands fa-linkedin fa-2x" aria-hidden="true"></i>
          </a>
        </li>
      
        <li class="sidebar__list-item">
          <a
            href="https://github.com/snowlyg/"
            target="_blank"
            rel="noopener me"
            aria-label="GitHub"
            title="GitHub"
          >
            <i class="fa-brands fa-github fa-2x" aria-hidden="true"></i>
          </a>
        </li>
      
        <li class="sidebar__list-item">
          <a
            href="https://x.com/rodin990"
            target="_blank"
            rel="noopener me"
            aria-label="X"
            title="X"
          >
            <i class="fa-brands fa-x fa-2x" aria-hidden="true"></i>
          </a>
        </li>
      
        <li class="sidebar__list-item">
          <a
            href="mailto:brendenaudrina6287@gmail.com"
            target="_blank"
            rel="noopener me"
            aria-label="e-mail"
            title="e-mail"
          >
            <i class="fa-solid fa-envelope fa-2x" aria-hidden="true"></i>
          </a>
        </li>
      
    </ul>
  </div><footer class="footer footer__sidebar">
  <ul class="footer__list">
    <li class="footer__item">
      &copy;
      
        Snowlyg 2020-2021
      
    </li>
    
  </ul>
</footer>
  
  <script
    type="text/javascript"
    src="/js/medium-zoom.min.1248fa75275e5ef0cbef27e8c1e27dc507c445ae3a2c7d2ed0be0809555dac64.js"
    integrity="sha256-Ekj6dSdeXvDL7yfoweJ9xQfERa46LH0u0L4ICVVdrGQ="
    crossorigin="anonymous"
  ></script></div>
</aside>
      <main
        
          class="wrapper__main"
        
      >
        <header class="header"><div
  class="
    animated fadeInDown
  "
>
  <a role="button" class="navbar-burger" data-target="navMenu" aria-label="menu" aria-expanded="false">
    <span aria-hidden="true" class="navbar-burger__line"></span>
    <span aria-hidden="true" class="navbar-burger__line"></span>
    <span aria-hidden="true" class="navbar-burger__line"></span>
  </a>
  <nav class="nav">
    <ul class="nav__list" id="navMenu">
      
      
        
        
          <li class="nav__list-item">
            
            <a
              
              href="/posts/"
              
              title="文章"
              >文章</a
            >
          </li>
        

      
        
        
          <li class="nav__list-item">
            
            <a
              
              href="/tags/"
              
              title="标签"
              >标签</a
            >
          </li>
        

      
        
        
          <li class="nav__list-item">
            
            <a
              
              href="/categories/"
              
              title="分类"
              >分类</a
            >
          </li>
        

      
        
        
          <li class="nav__list-item">
            
            <a
              
              href="https://www.github.com/snowlyg/iris/wiki"
              
                target="_blank" rel="noopener noreferrer"
              
              title="go-iris中文文档"
              >go-iris中文文档</a
            >
          </li>
        

      
        
        
          <li class="nav__list-item">
            
            <a
              
              href="https://brendenaudrina6287.gitbook.io/qor-doc-zh"
              
                target="_blank" rel="noopener noreferrer"
              
              title="qor中文文档"
              >qor中文文档</a
            >
          </li>
        

      
        
        
          <li class="nav__list-item">
            
            <a
              
              href="https://www.github.com/snowlyg"
              
                target="_blank" rel="noopener noreferrer"
              
              title="GITHUB"
              >GITHUB</a
            >
          </li>
        

      
    </ul>
    <ul class="nav__list nav__list--end">
      
      
        <li class="nav__list-item">
          <div class="themeswitch">
            <a title="Switch Theme">
              <i class="fas fa-adjust fa-fw" aria-hidden="true"></i>
            </a>
          </div>
        </li>
      
    </ul>
  </nav>
</div>
</header>
  <div
    class="post 
      animated fadeInDown
    "
  >
    
    <div class="post__content">
      
        <h1>Iris-Go框架构建登陆api项目开发详解</h1>
      
      <p>具体项目实例 <a href="https://github.com/snowlyg/IrisAdminApi">https://github.com/snowlyg/IrisAdminApi</a>
相关文章： <a href="https://blog.snowlyg.com/iris-go-api-2">iris + casbin 从陌生到学会使用的过程</a></p>
<p>很多新手学习 iris-go 的时候，看文档会觉得有些零散。而且英文文档对有些小伙伴来说还是有些吃力，就算用上翻译软件有些地方也会翻译的生涩难以理解。这篇文章主要会详细的讲解一下，我在写一个小项目的实现过程。本人功力有限，如果有错误地方，希望大家友善的指出。</p>
<h5 id="前言">前言</h5>
<ul>
<li>首先需要安装 <code>golang</code> 环境 。具体安装教程可以查看 <a href="https://learnku.com/docs/the-way-to-go">Go 入门指南</a></li>
<li>本地安装 <code>mysql</code> 或者 <code>gcc</code> (sqlite3) 环境 。<a href="http://mingw-w64.org/doku.php/download">gcc 下载地址</a>  建议下载解压版本，安装版本下载会比较慢。</li>
<li>开启 <code>GO111MODULE</code> 模式，设置镜像</li>
</ul>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl">go env -w <span class="nv">GO111MODULE</span><span class="o">=</span>on
</span></span><span class="line"><span class="cl">go env -w <span class="nv">GOPROXY</span><span class="o">=</span>https://goproxy.cn,direct
</span></span></code></pre></div><ul>
<li>初始化 <code>go.mod</code> 文件</li>
</ul>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl">go mod init
</span></span></code></pre></div><ul>
<li>安装 <code>gowatch</code>  ，类似  <code>bee run </code> 的一个工具。</li>
</ul>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl">go get github.com/silenceper/gowatch
</span></span></code></pre></div><blockquote>
<p>注意：如果是使用 goland Ide , 需要在 goland 的设置中为每一个项目单独开启 go moudels , 并且设置镜像地址，如下图。</p>
</blockquote>
<p><img alt="image.png" src="/posts/iris-go-api-1/MuHMlYUfo4.png"></p>
<h5 id="新建项目">新建项目</h5>
<ul>
<li>在 go/src/ (GOPATH) 目录下新建文件夹 <code>IrisAdminApi </code>，并新建 <code>main.go</code> 文件。官方文档例子 <a href="https://iris-go.com/start/#installation">https://iris-go.com/start/#installation</a>。</li>
</ul>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="kn">package</span> <span class="nx">main</span>
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="p">(</span>
</span></span><span class="line"><span class="cl">	<span class="s">&#34;github.com/kataras/iris/v12&#34;</span>
</span></span><span class="line"><span class="cl">	<span class="s">&#34;github.com/kataras/iris/v12/middleware/logger&#34;</span>
</span></span><span class="line"><span class="cl">	<span class="s">&#34;github.com/kataras/iris/v12/middleware/recover&#34;</span>
</span></span><span class="line"><span class="cl"><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="kd">func</span> <span class="nf">main</span><span class="p">(){</span>
</span></span><span class="line"><span class="cl">	<span class="nx">app</span> <span class="o">:=</span> <span class="nx">iris</span><span class="p">.</span><span class="nf">New</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">	<span class="nx">app</span><span class="p">.</span><span class="nf">Logger</span><span class="p">().</span><span class="nf">SetLevel</span><span class="p">(</span><span class="s">&#34;debug&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="c1">//可选的, 增加两个内置的处理程序
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="c1">// 一个可以让程序从任意的 http-relative panics 中恢复过来，
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="c1">// 一个可以记录日志到终端。
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="nx">app</span><span class="p">.</span><span class="nf">Use</span><span class="p">(</span><span class="nx">recover</span><span class="p">.</span><span class="nf">New</span><span class="p">())</span>
</span></span><span class="line"><span class="cl">	<span class="nx">app</span><span class="p">.</span><span class="nf">Use</span><span class="p">(</span><span class="nx">logger</span><span class="p">.</span><span class="nf">New</span><span class="p">())</span>
</span></span><span class="line"><span class="cl">	<span class="c1">// Method:   GET
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="c1">// Resource: http://localhost:8080
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="nx">app</span><span class="p">.</span><span class="nf">Handle</span><span class="p">(</span><span class="s">&#34;GET&#34;</span><span class="p">,</span> <span class="s">&#34;/&#34;</span><span class="p">,</span> <span class="kd">func</span><span class="p">(</span><span class="nx">ctx</span> <span class="nx">iris</span><span class="p">.</span><span class="nx">Context</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="nx">ctx</span><span class="p">.</span><span class="nf">HTML</span><span class="p">(</span><span class="s">&#34;&lt;h1&gt;Welcome&lt;/h1&gt;&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="p">})</span>
</span></span><span class="line"><span class="cl">	<span class="c1">// same as app.Handle(&#34;GET&#34;, &#34;/ping&#34;, [...])
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="c1">// Method:   GET
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="c1">// Resource: http://localhost:8080/ping
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="nx">app</span><span class="p">.</span><span class="nf">Get</span><span class="p">(</span><span class="s">&#34;/ping&#34;</span><span class="p">,</span> <span class="kd">func</span><span class="p">(</span><span class="nx">ctx</span> <span class="nx">iris</span><span class="p">.</span><span class="nx">Context</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="nx">ctx</span><span class="p">.</span><span class="nf">WriteString</span><span class="p">(</span><span class="s">&#34;pong&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="p">})</span>
</span></span><span class="line"><span class="cl">	<span class="c1">// Method:   GET
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="c1">// Resource: http://localhost:8080/hello
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="nx">app</span><span class="p">.</span><span class="nf">Get</span><span class="p">(</span><span class="s">&#34;/hello&#34;</span><span class="p">,</span> <span class="kd">func</span><span class="p">(</span><span class="nx">ctx</span> <span class="nx">iris</span><span class="p">.</span><span class="nx">Context</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="nx">ctx</span><span class="p">.</span><span class="nf">JSON</span><span class="p">(</span><span class="nx">iris</span><span class="p">.</span><span class="nx">Map</span><span class="p">{</span><span class="s">&#34;message&#34;</span><span class="p">:</span> <span class="s">&#34;Hello Iris!&#34;</span><span class="p">})</span>
</span></span><span class="line"><span class="cl">	<span class="p">})</span>
</span></span><span class="line"><span class="cl">	<span class="c1">// http://localhost:8080
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="c1">// http://localhost:8080/ping
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="c1">// http://localhost:8080/hello
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="nx">app</span><span class="p">.</span><span class="nf">Run</span><span class="p">(</span><span class="nx">iris</span><span class="p">.</span><span class="nf">Addr</span><span class="p">(</span><span class="s">&#34;:8080&#34;</span><span class="p">),</span> <span class="nx">iris</span><span class="p">.</span><span class="nf">WithoutServerError</span><span class="p">(</span><span class="nx">iris</span><span class="p">.</span><span class="nx">ErrServerClosed</span><span class="p">))</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><ul>
<li>加载相关包 <code>go mod tidy</code>,此时 <code>go.mod</code> 和 <code>go.sum</code> 会加载包的相关信息。</li>
</ul>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">// go.mod
</span></span><span class="line"><span class="cl">module IrisAdmin
</span></span><span class="line"><span class="cl">go 1.13
</span></span><span class="line"><span class="cl">require (
</span></span><span class="line"><span class="cl">	github.com/CloudyKit/fastprinter v0.0.0-20200109182630-33d98a066a53 // indirect
</span></span><span class="line"><span class="cl">	github.com/ajg/form v1.5.1 // indirect
</span></span><span class="line"><span class="cl">	github.com/fasthttp-contrib/websocket v0.0.0-20160511215533-1f3b11f56072 // indirect
</span></span><span class="line"><span class="cl">	github.com/google/go-querystring v1.0.0 // indirect
</span></span><span class="line"><span class="cl">	github.com/imkira/go-interpol v1.1.0 // indirect
</span></span><span class="line"><span class="cl">	github.com/k0kubun/colorstring v0.0.0-20150214042306-9440f1994b88 // indirect
</span></span><span class="line"><span class="cl">	github.com/kataras/iris/v12 v12.1.4
</span></span><span class="line"><span class="cl">	github.com/mattn/go-colorable v0.1.4 // indirect
</span></span><span class="line"><span class="cl">	github.com/modern-go/concurrent v0.0.0-20180306012644-bacd9c7ef1dd // indirect
</span></span><span class="line"><span class="cl">	github.com/modern-go/reflect2 v1.0.1 // indirect
</span></span><span class="line"><span class="cl">	github.com/moul/http2curl v1.0.0 // indirect
</span></span><span class="line"><span class="cl">	github.com/onsi/ginkgo v1.11.0 // indirect
</span></span><span class="line"><span class="cl">	github.com/onsi/gomega v1.8.1 // indirect
</span></span><span class="line"><span class="cl">	github.com/sergi/go-diff v1.1.0 // indirect
</span></span><span class="line"><span class="cl">	github.com/shurcooL/sanitized_anchor_name v1.0.0 // indirect
</span></span><span class="line"><span class="cl">	github.com/smartystreets/goconvey v1.6.4 // indirect
</span></span><span class="line"><span class="cl">	github.com/valyala/fasthttp v1.8.0 // indirect
</span></span><span class="line"><span class="cl">	github.com/xeipuuv/gojsonschema v1.2.0 // indirect
</span></span><span class="line"><span class="cl">	github.com/yalp/jsonpath v0.0.0-20180802001716-5cc68e5049a0 // indirect
</span></span><span class="line"><span class="cl">	github.com/yudai/gojsondiff v1.0.0 // indirect
</span></span><span class="line"><span class="cl">	github.com/yudai/golcs v0.0.0-20170316035057-ecda9a501e82 // indirect
</span></span><span class="line"><span class="cl">	github.com/yudai/pp v2.0.1+incompatible // indirect
</span></span><span class="line"><span class="cl">)
</span></span></code></pre></div><ul>
<li>启动项目 ，在项目目录运行 <code>gowatch</code>  或者 <code>go run main.go</code>。</li>
<li>输入 http://localhost:8080 ，得到如下显示就表启动成功了。</li>
</ul>
<p><img alt="image.png" src="/posts/iris-go-api-1/8DodD2AMnt.png"></p>
<h5 id="实现登陆退出功能">实现登陆，退出功能</h5>
<ul>
<li>到现在我们只是实现了一个简单的 web 服务器，和几个简单的接口。接下来我们要来实现网站的基本功能登陆和退出。</li>
<li>这里我们使用单元测试驱动开发相关接口，这样做的我们的项目后期的维护会变得相对容易一些。</li>
<li>首先要修改我们的 main.go 文件，新建一个 NewApp 方法，这个方法返回-个 *iris.Application ，这个是 iris.Application 的一个指针。（具体为什么是指针，这里就不详细讲解了。可以去看下  [Go 入门指南]https://learnku.com/docs/the-way-to-go ），这个方法在单元测试会用到。</li>
</ul>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="kn">package</span> <span class="nx">main</span>
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="p">(</span>
</span></span><span class="line"><span class="cl">	<span class="s">&#34;github.com/kataras/iris/v12&#34;</span>
</span></span><span class="line"><span class="cl">	<span class="s">&#34;github.com/kataras/iris/v12/middleware/logger&#34;</span>
</span></span><span class="line"><span class="cl">	<span class="s">&#34;github.com/kataras/iris/v12/middleware/recover&#34;</span>
</span></span><span class="line"><span class="cl"><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="kd">func</span> <span class="nf">main</span><span class="p">(){</span>
</span></span><span class="line"><span class="cl">	<span class="nx">app</span> <span class="o">:=</span> <span class="nf">NewApp</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">	<span class="c1">// http://localhost:8080
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="c1">// http://localhost:8080/ping
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="c1">// http://localhost:8080/hello
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="nx">app</span><span class="p">.</span><span class="nf">Run</span><span class="p">(</span><span class="nx">iris</span><span class="p">.</span><span class="nf">Addr</span><span class="p">(</span><span class="s">&#34;:8080&#34;</span><span class="p">),</span> <span class="nx">iris</span><span class="p">.</span><span class="nf">WithoutServerError</span><span class="p">(</span><span class="nx">iris</span><span class="p">.</span><span class="nx">ErrServerClosed</span><span class="p">))</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="kd">func</span> <span class="nf">NewApp</span><span class="p">()</span> <span class="o">*</span><span class="nx">iris</span><span class="p">.</span><span class="nx">Application</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="nx">app</span> <span class="o">:=</span> <span class="nx">iris</span><span class="p">.</span><span class="nf">New</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">	<span class="nx">app</span><span class="p">.</span><span class="nf">Logger</span><span class="p">().</span><span class="nf">SetLevel</span><span class="p">(</span><span class="s">&#34;debug&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="c1">// Optionally, add two built&#39;n handlers
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="c1">// that can recover from any http-relative panics
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="c1">// and log the requests to the terminal.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="nx">app</span><span class="p">.</span><span class="nf">Use</span><span class="p">(</span><span class="nx">recover</span><span class="p">.</span><span class="nf">New</span><span class="p">())</span>
</span></span><span class="line"><span class="cl">	<span class="nx">app</span><span class="p">.</span><span class="nf">Use</span><span class="p">(</span><span class="nx">logger</span><span class="p">.</span><span class="nf">New</span><span class="p">())</span>
</span></span><span class="line"><span class="cl">	<span class="c1">// Method:   GET
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="c1">// Resource: http://localhost:8080
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="nx">app</span><span class="p">.</span><span class="nf">Handle</span><span class="p">(</span><span class="s">&#34;GET&#34;</span><span class="p">,</span> <span class="s">&#34;/&#34;</span><span class="p">,</span> <span class="kd">func</span><span class="p">(</span><span class="nx">ctx</span> <span class="nx">iris</span><span class="p">.</span><span class="nx">Context</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="nx">ctx</span><span class="p">.</span><span class="nf">HTML</span><span class="p">(</span><span class="s">&#34;&lt;h1&gt;Welcome&lt;/h1&gt;&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="p">})</span>
</span></span><span class="line"><span class="cl">	<span class="c1">// same as app.Handle(&#34;GET&#34;, &#34;/ping&#34;, [...])
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="c1">// Method:   GET
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="c1">// Resource: http://localhost:8080/ping
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="nx">app</span><span class="p">.</span><span class="nf">Get</span><span class="p">(</span><span class="s">&#34;/ping&#34;</span><span class="p">,</span> <span class="kd">func</span><span class="p">(</span><span class="nx">ctx</span> <span class="nx">iris</span><span class="p">.</span><span class="nx">Context</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="nx">ctx</span><span class="p">.</span><span class="nf">WriteString</span><span class="p">(</span><span class="s">&#34;pong&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="p">})</span>
</span></span><span class="line"><span class="cl">	<span class="c1">// Method:   GET
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="c1">// Resource: http://localhost:8080/hello
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="nx">app</span><span class="p">.</span><span class="nf">Get</span><span class="p">(</span><span class="s">&#34;/hello&#34;</span><span class="p">,</span> <span class="kd">func</span><span class="p">(</span><span class="nx">ctx</span> <span class="nx">iris</span><span class="p">.</span><span class="nx">Context</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="nx">ctx</span><span class="p">.</span><span class="nf">JSON</span><span class="p">(</span><span class="nx">iris</span><span class="p">.</span><span class="nx">Map</span><span class="p">{</span><span class="s">&#34;message&#34;</span><span class="p">:</span> <span class="s">&#34;Hello Iris!&#34;</span><span class="p">})</span>
</span></span><span class="line"><span class="cl">	<span class="p">})</span>
</span></span><span class="line"><span class="cl">	<span class="k">return</span> <span class="nx">app</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><ul>
<li>在项目目录下新建测试文件 base_test.go` ，测试文件都以 _test.go 结尾。</li>
</ul>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="kn">package</span> <span class="nx">main</span>
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="p">(</span>
</span></span><span class="line"><span class="cl">	<span class="s">&#34;flag&#34;</span>
</span></span><span class="line"><span class="cl">	<span class="s">&#34;os&#34;</span>
</span></span><span class="line"><span class="cl">	<span class="s">&#34;testing&#34;</span>
</span></span><span class="line"><span class="cl">	<span class="s">&#34;github.com/gavv/httpexpect&#34;</span>
</span></span><span class="line"><span class="cl">	<span class="s">&#34;github.com/kataras/iris/v12&#34;</span>
</span></span><span class="line"><span class="cl">	<span class="s">&#34;github.com/kataras/iris/v12/httptest&#34;</span>
</span></span><span class="line"><span class="cl"><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="kd">const</span> <span class="nx">baseUrl</span> <span class="p">=</span> <span class="s">&#34;/v1/admin/&#34;</span>
</span></span><span class="line"><span class="cl"><span class="kd">const</span> <span class="nx">loginUrl</span> <span class="p">=</span> <span class="nx">baseUrl</span> <span class="o">+</span> <span class="s">&#34;login&#34;</span> <span class="c1">// 登陆接口地址
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kd">var</span> <span class="p">(</span>
</span></span><span class="line"><span class="cl">	<span class="nx">app</span>   <span class="o">*</span><span class="nx">iris</span><span class="p">.</span><span class="nx">Application</span> 
</span></span><span class="line"><span class="cl"><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="c1">//单元测试基境
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kd">func</span> <span class="nf">TestMain</span><span class="p">(</span><span class="nx">m</span> <span class="o">*</span><span class="nx">testing</span><span class="p">.</span><span class="nx">M</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="c1">// 初始化app
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="nx">app</span> <span class="p">=</span> <span class="nf">NewApp</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">	<span class="nx">flag</span><span class="p">.</span><span class="nf">Parse</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">	<span class="nx">exitCode</span> <span class="o">:=</span> <span class="nx">m</span><span class="p">.</span><span class="nf">Run</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">	<span class="nx">os</span><span class="p">.</span><span class="nf">Exit</span><span class="p">(</span><span class="nx">exitCode</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="c1">// 单元测试 login 方法
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kd">func</span> <span class="nf">login</span><span class="p">(</span><span class="nx">t</span> <span class="o">*</span><span class="nx">testing</span><span class="p">.</span><span class="nx">T</span><span class="p">,</span> <span class="nx">Object</span> <span class="kd">interface</span><span class="p">{},</span> <span class="nx">StatusCode</span> <span class="kt">int</span><span class="p">,</span> <span class="nx">Status</span> <span class="kt">bool</span><span class="p">,</span> <span class="nx">Msg</span> <span class="kt">string</span><span class="p">)</span> <span class="p">(</span><span class="nx">e</span> <span class="o">*</span><span class="nx">httpexpect</span><span class="p">.</span><span class="nx">Expect</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="nx">e</span> <span class="p">=</span> <span class="nx">httptest</span><span class="p">.</span><span class="nf">New</span><span class="p">(</span><span class="nx">t</span><span class="p">,</span> <span class="nx">app</span><span class="p">,</span> <span class="nx">httptest</span><span class="p">.</span><span class="nx">Configuration</span><span class="p">{</span><span class="nx">Debug</span><span class="p">:</span> <span class="kc">true</span><span class="p">})</span>
</span></span><span class="line"><span class="cl">	<span class="nx">e</span><span class="p">.</span><span class="nf">POST</span><span class="p">(</span><span class="nx">loginUrl</span><span class="p">).</span><span class="nf">WithJSON</span><span class="p">(</span><span class="nx">Object</span><span class="p">).</span><span class="nf">Expect</span><span class="p">().</span><span class="nf">Status</span><span class="p">(</span><span class="nx">StatusCode</span><span class="p">).</span><span class="nf">JSON</span><span class="p">().</span><span class="nf">Object</span><span class="p">().</span><span class="nf">Values</span><span class="p">().</span><span class="nf">Contains</span><span class="p">(</span><span class="nx">Status</span><span class="p">,</span> <span class="nx">Msg</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="k">return</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><ul>
<li>在项目目录下新建测试文件 <code>auth_test.go</code> 。</li>
</ul>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="kn">package</span> <span class="nx">main</span>
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="p">(</span>
</span></span><span class="line"><span class="cl">   <span class="s">&#34;testing&#34;</span>
</span></span><span class="line"><span class="cl"> <span class="s">&#34;github.com/kataras/iris/v12&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="c1">//登陆成功
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kd">func</span> <span class="nf">TestUserLoginSuccess</span><span class="p">(</span><span class="nx">t</span> <span class="o">*</span><span class="nx">testing</span><span class="p">.</span><span class="nx">T</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">   <span class="nx">oj</span> <span class="o">:=</span> <span class="kd">map</span><span class="p">[</span><span class="kt">string</span><span class="p">]</span><span class="kt">string</span><span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="s">&#34;username&#34;</span><span class="p">:</span> <span class="s">&#34;username&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="s">&#34;password&#34;</span><span class="p">:</span> <span class="s">&#34;password&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl">   <span class="nf">login</span><span class="p">(</span><span class="nx">t</span><span class="p">,</span> <span class="nx">oj</span><span class="p">,</span> <span class="nx">iris</span><span class="p">.</span><span class="nx">StatusOK</span><span class="p">,</span> <span class="kc">true</span><span class="p">,</span> <span class="s">&#34;登陆成功&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><ul>
<li>运行单元测试 <code>go test -run TestUserLoginSuccess</code>  单独执行登陆成功测试。得到如下错误：</li>
</ul>
<p><img alt="image.png" src="/posts/iris-go-api-1/XyIChVFxtW.png"></p>
<ul>
<li>为什么会报错，从报错信息我们知道本来要得到 200 的状态码，结果返回了 404 。因为我们没有定义登陆的路由。这里我们使用 gorm 包来管理数据，并使用 jwt 作为接口认证方式。</li>
<li>新建 user 模型，token 模型并实现相关方法。</li>
<li>新建数据库 iris , tiris 。这里要注意数据库的字符集要修改为 utf-8 ，不然会出中文乱码的情况。</li>
<li>引入了三个新的依赖包</li>
</ul>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">	&#34;github.com/iris-contrib/middleware/jwt&#34;
</span></span><span class="line"><span class="cl">	&#34;github.com/jameskeane/bcrypt&#34;
</span></span><span class="line"><span class="cl">	&#34;github.com/jinzhu/gorm&#34;
</span></span><span class="line"><span class="cl">	_ &#34;github.com/jinzhu/gorm/dialects/mysql&#34;
</span></span></code></pre></div><ul>
<li>增加 跨域中间件 和 jwt 认证中间件</li>
<li>完整代码如下</li>
</ul>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="kn">package</span> <span class="nx">main</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="p">(</span>
</span></span><span class="line"><span class="cl">   <span class="s">&#34;errors&#34;</span>
</span></span><span class="line"><span class="cl"> <span class="s">&#34;fmt&#34;</span> <span class="s">&#34;net/http&#34;</span> <span class="s">&#34;os&#34;</span> <span class="s">&#34;strconv&#34;</span> <span class="s">&#34;strings&#34;</span> <span class="s">&#34;time&#34;</span>
</span></span><span class="line"><span class="cl"> <span class="s">&#34;github.com/fatih/color&#34;</span> <span class="s">&#34;github.com/kataras/iris/v12/context&#34;</span>
</span></span><span class="line"><span class="cl"> <span class="s">&#34;github.com/kataras/iris/v12&#34;</span>
</span></span><span class="line"><span class="cl"> <span class="s">&#34;github.com/iris-contrib/middleware/cors&#34;</span> <span class="s">&#34;github.com/iris-contrib/middleware/jwt&#34;</span> <span class="s">&#34;github.com/jameskeane/bcrypt&#34;</span> <span class="s">&#34;github.com/jinzhu/gorm&#34;</span>  <span class="nx">_</span> <span class="s">&#34;github.com/jinzhu/gorm/dialects/mysql&#34;</span>
</span></span><span class="line"><span class="cl"> <span class="s">&#34;github.com/kataras/iris/v12/middleware/logger&#34;</span> <span class="s">&#34;github.com/kataras/iris/v12/middleware/recover&#34;</span>  <span class="nx">_</span> <span class="s">&#34;github.com/mattn/go-sqlite3&#34;</span>
</span></span><span class="line"><span class="cl"><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kd">var</span> <span class="nx">Db</span> <span class="o">*</span><span class="nx">gorm</span><span class="p">.</span><span class="nx">DB</span>
</span></span><span class="line"><span class="cl"><span class="kd">var</span> <span class="nx">err</span> <span class="kt">error</span>
</span></span><span class="line"><span class="cl"><span class="kd">var</span> <span class="nx">dirverName</span> <span class="kt">string</span>
</span></span><span class="line"><span class="cl"><span class="kd">var</span> <span class="nx">conn</span> <span class="kt">string</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">// 用户数据模型
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kd">type</span> <span class="nx">User</span> <span class="kd">struct</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">   <span class="nx">gorm</span><span class="p">.</span><span class="nx">Model</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="nx">Name</span>     <span class="kt">string</span> <span class="s">`gorm:&#34;not null VARCHAR(191)&#34;`</span>
</span></span><span class="line"><span class="cl">  <span class="nx">Username</span> <span class="kt">string</span> <span class="s">`gorm:&#34;unique;VARCHAR(191)&#34;`</span>
</span></span><span class="line"><span class="cl">  <span class="nx">Password</span> <span class="kt">string</span> <span class="s">`gorm:&#34;not null VARCHAR(191)&#34;`</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">// 接口返回数据对想
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kd">type</span> <span class="nx">Response</span> <span class="kd">struct</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">   <span class="nx">Status</span> <span class="kt">bool</span> <span class="s">`json:&#34;status&#34;`</span> <span class="c1">//接口状态 true ,false  Msg    interface{} `json:&#34;msg&#34;` // 接口信息
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="nx">Data</span>   <span class="kd">interface</span><span class="p">{}</span> <span class="s">`json:&#34;data&#34;`</span> <span class="c1">//接口数据
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">// token 数据模型
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kd">type</span> <span class="nx">OauthToken</span> <span class="kd">struct</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">   <span class="nx">gorm</span><span class="p">.</span><span class="nx">Model</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="nx">Token</span>     <span class="kt">string</span> <span class="s">`gorm:&#34;not null default &#39;&#39; comment(&#39;Token&#39;) VARCHAR(191)&#34;`</span>
</span></span><span class="line"><span class="cl">  <span class="nx">UserId</span>    <span class="kt">uint</span> <span class="s">`gorm:&#34;not null default &#39;&#39; comment(&#39;UserId&#39;) VARCHAR(191)&#34;`</span>
</span></span><span class="line"><span class="cl">  <span class="nx">Secret</span>    <span class="kt">string</span> <span class="s">`gorm:&#34;not null default &#39;&#39; comment(&#39;Secret&#39;) VARCHAR(191)&#34;`</span>
</span></span><span class="line"><span class="cl">  <span class="nx">ExpressIn</span> <span class="kt">int64</span> <span class="s">`gorm:&#34;not null default 0 comment(&#39;是否是标准库&#39;) BIGINT(20)&#34;`</span>
</span></span><span class="line"><span class="cl">  <span class="nx">Revoked</span>   <span class="kt">bool</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">// 创建 token
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kd">func</span> <span class="p">(</span><span class="nx">ot</span> <span class="o">*</span><span class="nx">OauthToken</span><span class="p">)</span> <span class="nf">OauthTokenCreate</span><span class="p">()</span> <span class="p">(</span><span class="nx">response</span> <span class="nx">Token</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">   <span class="nx">Db</span><span class="p">.</span><span class="nf">Create</span><span class="p">(</span><span class="nx">ot</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">   <span class="nx">response</span> <span class="p">=</span> <span class="nx">Token</span><span class="p">{</span><span class="nx">ot</span><span class="p">.</span><span class="nx">Token</span><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">   <span class="k">return</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kd">type</span> <span class="nx">Token</span> <span class="kd">struct</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">   <span class="nx">Token</span> <span class="kt">string</span> <span class="s">`json:&#34;access_token&#34;`</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">// 判断数据库是否返回 ErrRecordNotFound ，如果是说明数据库没有相关记录。
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kd">func</span> <span class="nf">IsNotFound</span><span class="p">(</span><span class="nx">err</span> <span class="kt">error</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">   <span class="k">if</span> <span class="nx">ok</span> <span class="o">:=</span> <span class="nx">errors</span><span class="p">.</span><span class="nf">Is</span><span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">gorm</span><span class="p">.</span><span class="nx">ErrRecordNotFound</span><span class="p">);</span> <span class="p">!</span><span class="nx">ok</span> <span class="o">&amp;&amp;</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="nx">color</span><span class="p">.</span><span class="nf">Red</span><span class="p">(</span><span class="nx">fmt</span><span class="p">.</span><span class="nf">Sprintf</span><span class="p">(</span><span class="s">&#34;error :%v \n &#34;</span><span class="p">,</span> <span class="nx">err</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">   <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">// 根据用户名查询用户
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kd">func</span> <span class="nf">UserAdminCheckLogin</span><span class="p">(</span><span class="nx">username</span> <span class="kt">string</span><span class="p">)</span> <span class="o">*</span><span class="nx">User</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">   <span class="nx">user</span> <span class="o">:=</span> <span class="nb">new</span><span class="p">(</span><span class="nx">User</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">   <span class="nf">IsNotFound</span><span class="p">(</span><span class="nx">Db</span><span class="p">.</span><span class="nf">Where</span><span class="p">(</span><span class="s">&#34;username = ?&#34;</span><span class="p">,</span> <span class="nx">username</span><span class="p">).</span><span class="nf">First</span><span class="p">(</span><span class="nx">user</span><span class="p">).</span><span class="nx">Error</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">   <span class="k">return</span> <span class="nx">user</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">// 登陆处理程序
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kd">func</span> <span class="nf">UserLogin</span><span class="p">(</span><span class="nx">ctx</span> <span class="nx">iris</span><span class="p">.</span><span class="nx">Context</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">   <span class="nx">aul</span> <span class="o">:=</span> <span class="nb">new</span><span class="p">(</span><span class="nx">User</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">   <span class="k">if</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">ctx</span><span class="p">.</span><span class="nf">ReadJSON</span><span class="p">(</span><span class="o">&amp;</span><span class="nx">aul</span><span class="p">);</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="nx">ctx</span><span class="p">.</span><span class="nf">StatusCode</span><span class="p">(</span><span class="nx">iris</span><span class="p">.</span><span class="nx">StatusOK</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">      <span class="nx">_</span><span class="p">,</span> <span class="nx">_</span> <span class="p">=</span> <span class="nx">ctx</span><span class="p">.</span><span class="nf">JSON</span><span class="p">(</span><span class="nx">Response</span><span class="p">{</span><span class="nx">Status</span><span class="p">:</span> <span class="kc">false</span><span class="p">,</span> <span class="nx">Msg</span><span class="p">:</span> <span class="kc">nil</span><span class="p">,</span> <span class="nx">Data</span><span class="p">:</span> <span class="s">&#34;请求参数错误&#34;</span><span class="p">})</span>
</span></span><span class="line"><span class="cl">      <span class="k">return</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">   <span class="nx">ctx</span><span class="p">.</span><span class="nf">StatusCode</span><span class="p">(</span><span class="nx">iris</span><span class="p">.</span><span class="nx">StatusOK</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">   <span class="nx">response</span><span class="p">,</span> <span class="nx">status</span><span class="p">,</span> <span class="nx">msg</span> <span class="o">:=</span> <span class="nf">CheckLogin</span><span class="p">(</span><span class="nx">aul</span><span class="p">.</span><span class="nx">Username</span><span class="p">,</span> <span class="nx">aul</span><span class="p">.</span><span class="nx">Password</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">   <span class="nx">_</span><span class="p">,</span> <span class="nx">_</span> <span class="p">=</span> <span class="nx">ctx</span><span class="p">.</span><span class="nf">JSON</span><span class="p">(</span><span class="nx">Response</span><span class="p">{</span><span class="nx">Status</span><span class="p">:</span> <span class="nx">status</span><span class="p">,</span> <span class="nx">Msg</span><span class="p">:</span> <span class="nx">response</span><span class="p">,</span> <span class="nx">Data</span><span class="p">:</span> <span class="nx">msg</span><span class="p">})</span>
</span></span><span class="line"><span class="cl">   <span class="k">return</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">// 检查登陆用户，并生成登陆凭证 token
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kd">func</span> <span class="nf">CheckLogin</span><span class="p">(</span><span class="nx">username</span><span class="p">,</span> <span class="nx">password</span> <span class="kt">string</span><span class="p">)</span> <span class="p">(</span><span class="nx">response</span> <span class="nx">Token</span><span class="p">,</span> <span class="nx">status</span> <span class="kt">bool</span><span class="p">,</span> <span class="nx">msg</span> <span class="kt">string</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">   <span class="nx">user</span> <span class="o">:=</span> <span class="nf">UserAdminCheckLogin</span><span class="p">(</span><span class="nx">username</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">   <span class="k">if</span> <span class="nx">user</span><span class="p">.</span><span class="nx">ID</span> <span class="o">==</span> <span class="mi">0</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="nx">msg</span> <span class="p">=</span> <span class="s">&#34;用户不存在&#34;</span>
</span></span><span class="line"><span class="cl">  <span class="k">return</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="k">if</span> <span class="nx">ok</span> <span class="o">:=</span> <span class="nx">bcrypt</span><span class="p">.</span><span class="nf">Match</span><span class="p">(</span><span class="nx">password</span><span class="p">,</span> <span class="nx">user</span><span class="p">.</span><span class="nx">Password</span><span class="p">);</span> <span class="nx">ok</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">         <span class="nx">token</span> <span class="o">:=</span> <span class="nx">jwt</span><span class="p">.</span><span class="nf">NewTokenWithClaims</span><span class="p">(</span><span class="nx">jwt</span><span class="p">.</span><span class="nx">SigningMethodHS256</span><span class="p">,</span> <span class="nx">jwt</span><span class="p">.</span><span class="nx">MapClaims</span><span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="s">&#34;exp&#34;</span><span class="p">:</span> <span class="nx">time</span><span class="p">.</span><span class="nf">Now</span><span class="p">().</span><span class="nf">Add</span><span class="p">(</span><span class="nx">time</span><span class="p">.</span><span class="nx">Hour</span> <span class="o">*</span> <span class="nx">time</span><span class="p">.</span><span class="nf">Duration</span><span class="p">(</span><span class="mi">1</span><span class="p">)).</span><span class="nf">Unix</span><span class="p">(),</span>
</span></span><span class="line"><span class="cl">  <span class="s">&#34;iat&#34;</span><span class="p">:</span> <span class="nx">time</span><span class="p">.</span><span class="nf">Now</span><span class="p">().</span><span class="nf">Unix</span><span class="p">(),</span>
</span></span><span class="line"><span class="cl">  <span class="p">})</span>
</span></span><span class="line"><span class="cl">         <span class="nx">tokenString</span><span class="p">,</span> <span class="nx">_</span> <span class="o">:=</span> <span class="nx">token</span><span class="p">.</span><span class="nf">SignedString</span><span class="p">([]</span><span class="nb">byte</span><span class="p">(</span><span class="s">&#34;HS2JDFKhu7Y1av7b&#34;</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">         <span class="nx">oauthToken</span> <span class="o">:=</span> <span class="nb">new</span><span class="p">(</span><span class="nx">OauthToken</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">         <span class="nx">oauthToken</span><span class="p">.</span><span class="nx">Token</span> <span class="p">=</span> <span class="nx">tokenString</span>
</span></span><span class="line"><span class="cl">         <span class="nx">oauthToken</span><span class="p">.</span><span class="nx">UserId</span> <span class="p">=</span> <span class="nx">user</span><span class="p">.</span><span class="nx">ID</span>
</span></span><span class="line"><span class="cl">         <span class="nx">oauthToken</span><span class="p">.</span><span class="nx">Secret</span> <span class="p">=</span> <span class="s">&#34;secret&#34;</span>
</span></span><span class="line"><span class="cl">  <span class="nx">oauthToken</span><span class="p">.</span><span class="nx">Revoked</span> <span class="p">=</span> <span class="kc">false</span>
</span></span><span class="line"><span class="cl">  <span class="nx">oauthToken</span><span class="p">.</span><span class="nx">ExpressIn</span> <span class="p">=</span> <span class="nx">time</span><span class="p">.</span><span class="nf">Now</span><span class="p">().</span><span class="nf">Add</span><span class="p">(</span><span class="nx">time</span><span class="p">.</span><span class="nx">Hour</span> <span class="o">*</span> <span class="nx">time</span><span class="p">.</span><span class="nf">Duration</span><span class="p">(</span><span class="mi">1</span><span class="p">)).</span><span class="nf">Unix</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">         <span class="nx">oauthToken</span><span class="p">.</span><span class="nx">CreatedAt</span> <span class="p">=</span> <span class="nx">time</span><span class="p">.</span><span class="nf">Now</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">         <span class="nx">response</span> <span class="p">=</span> <span class="nx">oauthToken</span><span class="p">.</span><span class="nf">OauthTokenCreate</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">         <span class="nx">status</span> <span class="p">=</span> <span class="kc">true</span>
</span></span><span class="line"><span class="cl">  <span class="nx">msg</span> <span class="p">=</span> <span class="s">&#34;登陆成功&#34;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="k">return</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">         <span class="nx">msg</span> <span class="p">=</span> <span class="s">&#34;用户名或密码错误&#34;</span>
</span></span><span class="line"><span class="cl">  <span class="k">return</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl">   <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">// 作废token
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kd">func</span> <span class="nf">UpdateOauthTokenByUserId</span><span class="p">(</span><span class="nx">userId</span> <span class="kt">uint</span><span class="p">)</span> <span class="p">(</span><span class="nx">ot</span> <span class="o">*</span><span class="nx">OauthToken</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">   <span class="nx">Db</span><span class="p">.</span><span class="nf">Model</span><span class="p">(</span><span class="nx">ot</span><span class="p">).</span><span class="nf">Where</span><span class="p">(</span><span class="s">&#34;revoked = ?&#34;</span><span class="p">,</span> <span class="kc">false</span><span class="p">).</span>
</span></span><span class="line"><span class="cl">      <span class="nf">Where</span><span class="p">(</span><span class="s">&#34;user_id = ?&#34;</span><span class="p">,</span> <span class="nx">userId</span><span class="p">).</span>
</span></span><span class="line"><span class="cl">      <span class="nf">Updates</span><span class="p">(</span><span class="kd">map</span><span class="p">[</span><span class="kt">string</span><span class="p">]</span><span class="kd">interface</span><span class="p">{}{</span><span class="s">&#34;revoked&#34;</span><span class="p">:</span> <span class="kc">true</span><span class="p">})</span>
</span></span><span class="line"><span class="cl">   <span class="k">return</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">// 登出用户
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kd">func</span> <span class="nf">UserAdminLogout</span><span class="p">(</span><span class="nx">userId</span> <span class="kt">uint</span><span class="p">)</span> <span class="kt">bool</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">   <span class="nx">ot</span> <span class="o">:=</span> <span class="nf">UpdateOauthTokenByUserId</span><span class="p">(</span><span class="nx">userId</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">   <span class="k">return</span> <span class="nx">ot</span><span class="p">.</span><span class="nx">Revoked</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">// 登出
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kd">func</span> <span class="nf">UserLogout</span><span class="p">(</span><span class="nx">ctx</span> <span class="nx">iris</span><span class="p">.</span><span class="nx">Context</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">   <span class="nx">aui</span> <span class="o">:=</span> <span class="nx">ctx</span><span class="p">.</span><span class="nf">Values</span><span class="p">().</span><span class="nf">GetString</span><span class="p">(</span><span class="s">&#34;auth_user_id&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">   <span class="nx">id</span><span class="p">,</span> <span class="nx">_</span> <span class="o">:=</span> <span class="nx">strconv</span><span class="p">.</span><span class="nf">Atoi</span><span class="p">(</span><span class="nx">aui</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">   <span class="nf">UserAdminLogout</span><span class="p">(</span><span class="nb">uint</span><span class="p">(</span><span class="nx">id</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">   <span class="nx">ctx</span><span class="p">.</span><span class="nf">StatusCode</span><span class="p">(</span><span class="nx">http</span><span class="p">.</span><span class="nx">StatusOK</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">   <span class="nx">_</span><span class="p">,</span> <span class="nx">_</span> <span class="p">=</span> <span class="nx">ctx</span><span class="p">.</span><span class="nf">JSON</span><span class="p">(</span><span class="nx">Response</span><span class="p">{</span><span class="kc">true</span><span class="p">,</span> <span class="kc">nil</span><span class="p">,</span> <span class="s">&#34;退出&#34;</span><span class="p">})</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">//获取程序运行环境
</span></span></span><span class="line"><span class="cl"><span class="c1">// 根据程序运行路径后缀判断
</span></span></span><span class="line"><span class="cl"><span class="c1">//如果是 test 就是测试环境
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kd">func</span> <span class="nf">isTestEnv</span><span class="p">()</span> <span class="kt">bool</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">   <span class="nx">files</span> <span class="o">:=</span> <span class="nx">os</span><span class="p">.</span><span class="nx">Args</span>
</span></span><span class="line"><span class="cl">   <span class="k">for</span> <span class="nx">_</span><span class="p">,</span> <span class="nx">v</span> <span class="o">:=</span> <span class="k">range</span> <span class="nx">files</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="k">if</span> <span class="nx">strings</span><span class="p">.</span><span class="nf">Contains</span><span class="p">(</span><span class="nx">v</span><span class="p">,</span> <span class="s">&#34;test&#34;</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">         <span class="k">return</span> <span class="kc">true</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl">   <span class="p">}</span>
</span></span><span class="line"><span class="cl">   <span class="k">return</span> <span class="kc">false</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">// 接口跨域处理
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kd">func</span> <span class="nf">CrsAuth</span><span class="p">()</span> <span class="nx">context</span><span class="p">.</span><span class="nx">Handler</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">   <span class="k">return</span> <span class="nx">cors</span><span class="p">.</span><span class="nf">New</span><span class="p">(</span><span class="nx">cors</span><span class="p">.</span><span class="nx">Options</span><span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="nx">AllowedOrigins</span><span class="p">:</span>   <span class="p">[]</span><span class="kt">string</span><span class="p">{</span><span class="s">&#34;*&#34;</span><span class="p">},</span> <span class="c1">// allows everything, use that to change the hosts.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="nx">AllowedMethods</span><span class="p">:</span>   <span class="p">[]</span><span class="kt">string</span><span class="p">{</span><span class="s">&#34;PUT&#34;</span><span class="p">,</span> <span class="s">&#34;PATCH&#34;</span><span class="p">,</span> <span class="s">&#34;GET&#34;</span><span class="p">,</span> <span class="s">&#34;POST&#34;</span><span class="p">,</span> <span class="s">&#34;OPTIONS&#34;</span><span class="p">,</span> <span class="s">&#34;DELETE&#34;</span><span class="p">},</span>
</span></span><span class="line"><span class="cl">  <span class="nx">AllowedHeaders</span><span class="p">:</span>   <span class="p">[]</span><span class="kt">string</span><span class="p">{</span><span class="s">&#34;*&#34;</span><span class="p">},</span>
</span></span><span class="line"><span class="cl">  <span class="nx">ExposedHeaders</span><span class="p">:</span>   <span class="p">[]</span><span class="kt">string</span><span class="p">{</span><span class="s">&#34;Accept&#34;</span><span class="p">,</span> <span class="s">&#34;Content-Type&#34;</span><span class="p">,</span> <span class="s">&#34;Content-Length&#34;</span><span class="p">,</span> <span class="s">&#34;Accept-Encoding&#34;</span><span class="p">,</span> <span class="s">&#34;X-CSRF-Token&#34;</span><span class="p">,</span> <span class="s">&#34;Authorization&#34;</span><span class="p">},</span>
</span></span><span class="line"><span class="cl">  <span class="nx">AllowCredentials</span><span class="p">:</span> <span class="kc">true</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="p">})</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">// 获取 access_token 信息
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kd">func</span> <span class="nf">GetOauthTokenByToken</span><span class="p">(</span><span class="nx">token</span> <span class="kt">string</span><span class="p">)</span> <span class="p">(</span><span class="nx">ot</span> <span class="o">*</span><span class="nx">OauthToken</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">   <span class="nx">ot</span> <span class="p">=</span> <span class="nb">new</span><span class="p">(</span><span class="nx">OauthToken</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">   <span class="nx">Db</span><span class="p">.</span><span class="nf">Where</span><span class="p">(</span><span class="s">&#34;token =  ?&#34;</span><span class="p">,</span> <span class="nx">token</span><span class="p">).</span><span class="nf">First</span><span class="p">(</span><span class="o">&amp;</span><span class="nx">ot</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">   <span class="k">return</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="cm">/**
</span></span></span><span class="line"><span class="cl"><span class="cm"> * 验证 jwt * @method JwtHandler */</span>
</span></span><span class="line"><span class="cl"> <span class="kd">func</span> <span class="nf">JwtHandler</span><span class="p">()</span> <span class="o">*</span><span class="nx">jwt</span><span class="p">.</span><span class="nx">Middleware</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">   <span class="kd">var</span> <span class="nx">mySecret</span> <span class="p">=</span> <span class="p">[]</span><span class="nb">byte</span><span class="p">(</span><span class="s">&#34;HS2JDFKhu7Y1av7b&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">   <span class="k">return</span> <span class="nx">jwt</span><span class="p">.</span><span class="nf">New</span><span class="p">(</span><span class="nx">jwt</span><span class="p">.</span><span class="nx">Config</span><span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="nx">ValidationKeyGetter</span><span class="p">:</span> <span class="kd">func</span><span class="p">(</span><span class="nx">token</span> <span class="o">*</span><span class="nx">jwt</span><span class="p">.</span><span class="nx">Token</span><span class="p">)</span> <span class="p">(</span><span class="kd">interface</span><span class="p">{},</span> <span class="kt">error</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">         <span class="k">return</span> <span class="nx">mySecret</span><span class="p">,</span> <span class="kc">nil</span>
</span></span><span class="line"><span class="cl">  <span class="p">},</span>
</span></span><span class="line"><span class="cl">  <span class="nx">SigningMethod</span><span class="p">:</span> <span class="nx">jwt</span><span class="p">.</span><span class="nx">SigningMethodHS256</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="p">})</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kd">func</span> <span class="nf">AuthToken</span><span class="p">(</span><span class="nx">ctx</span> <span class="nx">context</span><span class="p">.</span><span class="nx">Context</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">   <span class="nx">value</span> <span class="o">:=</span> <span class="nx">ctx</span><span class="p">.</span><span class="nf">Values</span><span class="p">().</span><span class="nf">Get</span><span class="p">(</span><span class="s">&#34;jwt&#34;</span><span class="p">).(</span><span class="o">*</span><span class="nx">jwt</span><span class="p">.</span><span class="nx">Token</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">   <span class="nx">token</span> <span class="o">:=</span> <span class="nf">GetOauthTokenByToken</span><span class="p">(</span><span class="nx">value</span><span class="p">.</span><span class="nx">Raw</span><span class="p">)</span> <span class="c1">//获取 access_token 信息
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="k">if</span> <span class="nx">token</span><span class="p">.</span><span class="nx">Revoked</span> <span class="o">||</span> <span class="nx">token</span><span class="p">.</span><span class="nx">ExpressIn</span> <span class="p">&lt;</span> <span class="nx">time</span><span class="p">.</span><span class="nf">Now</span><span class="p">().</span><span class="nf">Unix</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="c1">//_, _ = ctx.Writef(&#34;token 失效，请重新登录&#34;) // 输出到前端
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="nx">ctx</span><span class="p">.</span><span class="nf">StatusCode</span><span class="p">(</span><span class="nx">http</span><span class="p">.</span><span class="nx">StatusUnauthorized</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">      <span class="nx">ctx</span><span class="p">.</span><span class="nf">StopExecution</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">      <span class="k">return</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="nx">ctx</span><span class="p">.</span><span class="nf">Values</span><span class="p">().</span><span class="nf">Set</span><span class="p">(</span><span class="s">&#34;auth_user_id&#34;</span><span class="p">,</span> <span class="nx">token</span><span class="p">.</span><span class="nx">UserId</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">   <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">   <span class="nx">ctx</span><span class="p">.</span><span class="nf">Next</span><span class="p">()</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kd">func</span> <span class="nf">NewApp</span><span class="p">()</span> <span class="o">*</span><span class="nx">iris</span><span class="p">.</span><span class="nx">Application</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">   <span class="nx">dirverName</span> <span class="p">=</span> <span class="s">&#34;mysql&#34;</span>
</span></span><span class="line"><span class="cl">  <span class="k">if</span> <span class="nf">isTestEnv</span><span class="p">()</span> <span class="p">{</span> <span class="c1">//如果是测试使用测试数据库
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="nx">conn</span> <span class="p">=</span> <span class="s">&#34;root:wemT5ZNuo074i4FNsTwl4KhfVSvOlBcF@(127.0.0.1:3306)/tiris?charset=utf8&amp;parseTime=True&amp;loc=Local&#34;</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="nx">conn</span> <span class="p">=</span> <span class="s">&#34;root:wemT5ZNuo074i4FNsTwl4KhfVSvOlBcF@(127.0.0.1:3306)/iris?charset=utf8&amp;parseTime=True&amp;loc=Local&#34;</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">   <span class="c1">//初始化数据库
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="nx">Db</span><span class="p">,</span> <span class="nx">err</span> <span class="p">=</span> <span class="nx">gorm</span><span class="p">.</span><span class="nf">Open</span><span class="p">(</span><span class="nx">dirverName</span><span class="p">,</span> <span class="nx">conn</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">   <span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="nx">color</span><span class="p">.</span><span class="nf">Red</span><span class="p">(</span><span class="nx">fmt</span><span class="p">.</span><span class="nf">Sprintf</span><span class="p">(</span><span class="s">&#34;gorm open 错误: %v&#34;</span><span class="p">,</span> <span class="nx">err</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">   <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">   <span class="nx">app</span> <span class="o">:=</span> <span class="nx">iris</span><span class="p">.</span><span class="nf">New</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">   <span class="nx">app</span><span class="p">.</span><span class="nf">Logger</span><span class="p">().</span><span class="nf">SetLevel</span><span class="p">(</span><span class="s">&#34;debug&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">   <span class="nx">app</span><span class="p">.</span><span class="nf">Use</span><span class="p">(</span><span class="nx">recover</span><span class="p">.</span><span class="nf">New</span><span class="p">())</span>
</span></span><span class="line"><span class="cl">   <span class="nx">app</span><span class="p">.</span><span class="nf">Use</span><span class="p">(</span><span class="nx">logger</span><span class="p">.</span><span class="nf">New</span><span class="p">())</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">   <span class="c1">// 路由集使用跨域中间件 CrsAuth() 
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>   <span class="c1">// 允许 Options 方法 AllowMethods(iris.MethodOptions)
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="nx">main</span> <span class="o">:=</span> <span class="nx">app</span><span class="p">.</span><span class="nf">Party</span><span class="p">(</span><span class="s">&#34;/&#34;</span><span class="p">,</span> <span class="nf">CrsAuth</span><span class="p">()).</span><span class="nf">AllowMethods</span><span class="p">(</span><span class="nx">iris</span><span class="p">.</span><span class="nx">MethodOptions</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">   <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="nx">v1</span> <span class="o">:=</span> <span class="nx">main</span><span class="p">.</span><span class="nf">Party</span><span class="p">(</span><span class="s">&#34;/v1&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">      <span class="p">{</span>
</span></span><span class="line"><span class="cl">         <span class="nx">v1</span><span class="p">.</span><span class="nf">Post</span><span class="p">(</span><span class="s">&#34;/admin/login&#34;</span><span class="p">,</span> <span class="nx">UserLogin</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">         <span class="nx">v1</span><span class="p">.</span><span class="nf">PartyFunc</span><span class="p">(</span><span class="s">&#34;/admin&#34;</span><span class="p">,</span> <span class="kd">func</span><span class="p">(</span><span class="nx">admin</span> <span class="nx">iris</span><span class="p">.</span><span class="nx">Party</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="nx">admin</span><span class="p">.</span><span class="nf">Use</span><span class="p">(</span><span class="nf">JwtHandler</span><span class="p">().</span><span class="nx">Serve</span><span class="p">,</span> <span class="nx">AuthToken</span><span class="p">)</span> <span class="c1">//登录验证
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="nx">admin</span><span class="p">.</span><span class="nf">Get</span><span class="p">(</span><span class="s">&#34;/logout&#34;</span><span class="p">,</span> <span class="nx">UserLogout</span><span class="p">).</span><span class="nx">Name</span> <span class="p">=</span> <span class="s">&#34;退出&#34;</span>
</span></span><span class="line"><span class="cl">  <span class="p">})</span>
</span></span><span class="line"><span class="cl">      <span class="p">}</span>
</span></span><span class="line"><span class="cl">   <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">   <span class="k">return</span> <span class="nx">app</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kd">func</span> <span class="nf">main</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">   <span class="nx">app</span> <span class="o">:=</span> <span class="nf">NewApp</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">   <span class="nx">app</span><span class="p">.</span><span class="nf">Run</span><span class="p">(</span><span class="nx">iris</span><span class="p">.</span><span class="nf">Addr</span><span class="p">(</span><span class="s">&#34;:8080&#34;</span><span class="p">),</span> <span class="nx">iris</span><span class="p">.</span><span class="nf">WithoutServerError</span><span class="p">(</span><span class="nx">iris</span><span class="p">.</span><span class="nx">ErrServerClosed</span><span class="p">))</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><ul>
<li>这时候再执行测试命令 <code>go test -run TestUserLoginSuccess</code> 我们会得到如下错误：</li>
</ul>
<p><img alt="image.png" src="/posts/iris-go-api-1/xfaAFqhOf4.png"></p>
<ul>
<li>现在已经不再是 404 的错误了， 而是返回一个用户不存在的信息。原因是虽然我们增加了路由已经一系列的相关代码</li>
<li>但是数据库并没有用户数据 ，我们自然无法查询到任何用户信息。</li>
<li>那么要如何解决这问题呢？</li>
<li>同时你会发现到现在的 main.go 文件非常庞大臃肿，无论是修改代码，还是追踪错误都是非常麻烦。应该如何调整？</li>
<li>前文讲到 权限控制又该如何实现？</li>
</ul>
<h5 id="重构项目结构">重构项目结构</h5>
<ul>
<li>现在我们调整文件代码，划分项目结构如下</li>
<li>controllers // 控制器
<ul>
<li>access.go</li>
</ul>
</li>
</ul>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-gdscript3" data-lang="gdscript3"><span class="line"><span class="cl">	<span class="n">package</span> <span class="n">controllers</span>
</span></span><span class="line"><span class="cl"><span class="n">import</span> <span class="p">(</span>
</span></span><span class="line"><span class="cl">	<span class="s2">&#34;net/http&#34;</span>
</span></span><span class="line"><span class="cl">	<span class="s2">&#34;strconv&#34;</span>
</span></span><span class="line"><span class="cl">	<span class="s2">&#34;IrisAdmin/models&#34;</span>
</span></span><span class="line"><span class="cl">	<span class="s2">&#34;github.com/kataras/iris/v12&#34;</span>
</span></span><span class="line"><span class="cl"><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="o">//</span> <span class="err">登陆处理程序</span>
</span></span><span class="line"><span class="cl"><span class="k">func</span> <span class="n">UserLogin</span><span class="p">(</span><span class="n">ctx</span> <span class="n">iris</span><span class="o">.</span><span class="n">Context</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="n">aul</span> <span class="p">:</span><span class="o">=</span> <span class="n">new</span><span class="p">(</span><span class="n">models</span><span class="o">.</span><span class="n">User</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="k">if</span> <span class="n">err</span> <span class="p">:</span><span class="o">=</span> <span class="n">ctx</span><span class="o">.</span><span class="n">ReadJSON</span><span class="p">(</span><span class="o">&amp;</span><span class="n">aul</span><span class="p">);</span> <span class="n">err</span> <span class="o">!=</span> <span class="n">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="n">ctx</span><span class="o">.</span><span class="n">StatusCode</span><span class="p">(</span><span class="n">iris</span><span class="o">.</span><span class="n">StatusOK</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">		<span class="n">_</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">ctx</span><span class="o">.</span><span class="n">JSON</span><span class="p">(</span><span class="n">models</span><span class="o">.</span><span class="n">Response</span><span class="p">{</span><span class="n">Status</span><span class="p">:</span> <span class="bp">false</span><span class="p">,</span> <span class="n">Msg</span><span class="p">:</span> <span class="n">nil</span><span class="p">,</span> <span class="n">Data</span><span class="p">:</span> <span class="s2">&#34;请求参数错误&#34;</span><span class="p">})</span>
</span></span><span class="line"><span class="cl">		<span class="k">return</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">	<span class="n">ctx</span><span class="o">.</span><span class="n">StatusCode</span><span class="p">(</span><span class="n">iris</span><span class="o">.</span><span class="n">StatusOK</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="n">response</span><span class="p">,</span> <span class="n">status</span><span class="p">,</span> <span class="n">msg</span> <span class="p">:</span><span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">CheckLogin</span><span class="p">(</span><span class="n">aul</span><span class="o">.</span><span class="n">Username</span><span class="p">,</span> <span class="n">aul</span><span class="o">.</span><span class="n">Password</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="n">_</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">ctx</span><span class="o">.</span><span class="n">JSON</span><span class="p">(</span><span class="n">models</span><span class="o">.</span><span class="n">Response</span><span class="p">{</span><span class="n">Status</span><span class="p">:</span> <span class="n">status</span><span class="p">,</span> <span class="n">Msg</span><span class="p">:</span> <span class="n">response</span><span class="p">,</span> <span class="n">Data</span><span class="p">:</span> <span class="n">msg</span><span class="p">})</span>
</span></span><span class="line"><span class="cl">	<span class="k">return</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="o">//</span> <span class="err">登出</span>
</span></span><span class="line"><span class="cl"><span class="k">func</span> <span class="n">UserLogout</span><span class="p">(</span><span class="n">ctx</span> <span class="n">iris</span><span class="o">.</span><span class="n">Context</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="n">aui</span> <span class="p">:</span><span class="o">=</span> <span class="n">ctx</span><span class="o">.</span><span class="n">Values</span><span class="p">()</span><span class="o">.</span><span class="n">GetString</span><span class="p">(</span><span class="s2">&#34;auth_user_id&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="n">id</span><span class="p">,</span> <span class="n">_</span> <span class="p">:</span><span class="o">=</span> <span class="n">strconv</span><span class="o">.</span><span class="n">Atoi</span><span class="p">(</span><span class="n">aui</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="n">models</span><span class="o">.</span><span class="n">UserAdminLogout</span><span class="p">(</span><span class="n">uint</span><span class="p">(</span><span class="n">id</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">	<span class="n">ctx</span><span class="o">.</span><span class="n">StatusCode</span><span class="p">(</span><span class="n">http</span><span class="o">.</span><span class="n">StatusOK</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="n">_</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">ctx</span><span class="o">.</span><span class="n">JSON</span><span class="p">(</span><span class="n">models</span><span class="o">.</span><span class="n">Response</span><span class="p">{</span><span class="bp">true</span><span class="p">,</span> <span class="n">nil</span><span class="p">,</span> <span class="s2">&#34;退出&#34;</span><span class="p">})</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><ul>
<li>middleware // 中间件
<ul>
<li>auth.go  // 验证登陆</li>
</ul>
</li>
</ul>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="kn">package</span> <span class="nx">middleware</span>
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="p">(</span>
</span></span><span class="line"><span class="cl">	<span class="s">&#34;net/http&#34;</span>
</span></span><span class="line"><span class="cl">	<span class="s">&#34;time&#34;</span>
</span></span><span class="line"><span class="cl">	<span class="s">&#34;IrisAdmin/models&#34;</span>
</span></span><span class="line"><span class="cl">	<span class="s">&#34;github.com/iris-contrib/middleware/jwt&#34;</span>
</span></span><span class="line"><span class="cl">	<span class="s">&#34;github.com/kataras/iris/v12/context&#34;</span>
</span></span><span class="line"><span class="cl"><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="kd">func</span> <span class="nf">AuthToken</span><span class="p">(</span><span class="nx">ctx</span> <span class="nx">context</span><span class="p">.</span><span class="nx">Context</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="nx">value</span> <span class="o">:=</span> <span class="nx">ctx</span><span class="p">.</span><span class="nf">Values</span><span class="p">().</span><span class="nf">Get</span><span class="p">(</span><span class="s">&#34;jwt&#34;</span><span class="p">).(</span><span class="o">*</span><span class="nx">jwt</span><span class="p">.</span><span class="nx">Token</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="nx">token</span> <span class="o">:=</span> <span class="nx">models</span><span class="p">.</span><span class="nf">GetOauthTokenByToken</span><span class="p">(</span><span class="nx">value</span><span class="p">.</span><span class="nx">Raw</span><span class="p">)</span> <span class="c1">//获取 access_token 信息
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="k">if</span> <span class="nx">token</span><span class="p">.</span><span class="nx">Revoked</span> <span class="o">||</span> <span class="nx">token</span><span class="p">.</span><span class="nx">ExpressIn</span> <span class="p">&lt;</span> <span class="nx">time</span><span class="p">.</span><span class="nf">Now</span><span class="p">().</span><span class="nf">Unix</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="c1">//_, _ = ctx.Writef(&#34;token 失效，请重新登录&#34;) // 输出到前端
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>		<span class="nx">ctx</span><span class="p">.</span><span class="nf">StatusCode</span><span class="p">(</span><span class="nx">http</span><span class="p">.</span><span class="nx">StatusUnauthorized</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">		<span class="nx">ctx</span><span class="p">.</span><span class="nf">StopExecution</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">		<span class="k">return</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="nx">ctx</span><span class="p">.</span><span class="nf">Values</span><span class="p">().</span><span class="nf">Set</span><span class="p">(</span><span class="s">&#34;auth_user_id&#34;</span><span class="p">,</span> <span class="nx">token</span><span class="p">.</span><span class="nx">UserId</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">	<span class="nx">ctx</span><span class="p">.</span><span class="nf">Next</span><span class="p">()</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><pre><code>- crs.go // 跨域认证
</code></pre>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="kn">package</span> <span class="nx">middleware</span>
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="p">(</span>
</span></span><span class="line"><span class="cl">	<span class="s">&#34;github.com/iris-contrib/middleware/cors&#34;</span>
</span></span><span class="line"><span class="cl">	<span class="s">&#34;github.com/kataras/iris/v12/context&#34;</span>
</span></span><span class="line"><span class="cl"><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="kd">func</span> <span class="nf">CrsAuth</span><span class="p">()</span> <span class="nx">context</span><span class="p">.</span><span class="nx">Handler</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="k">return</span> <span class="nx">cors</span><span class="p">.</span><span class="nf">New</span><span class="p">(</span><span class="nx">cors</span><span class="p">.</span><span class="nx">Options</span><span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="nx">AllowedOrigins</span><span class="p">:</span>   <span class="p">[]</span><span class="kt">string</span><span class="p">{</span><span class="s">&#34;*&#34;</span><span class="p">},</span> <span class="c1">// allows everything, use that to change the hosts.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>		<span class="nx">AllowedMethods</span><span class="p">:</span>   <span class="p">[]</span><span class="kt">string</span><span class="p">{</span><span class="s">&#34;PUT&#34;</span><span class="p">,</span> <span class="s">&#34;PATCH&#34;</span><span class="p">,</span> <span class="s">&#34;GET&#34;</span><span class="p">,</span> <span class="s">&#34;POST&#34;</span><span class="p">,</span> <span class="s">&#34;OPTIONS&#34;</span><span class="p">,</span> <span class="s">&#34;DELETE&#34;</span><span class="p">},</span>
</span></span><span class="line"><span class="cl">		<span class="nx">AllowedHeaders</span><span class="p">:</span>   <span class="p">[]</span><span class="kt">string</span><span class="p">{</span><span class="s">&#34;*&#34;</span><span class="p">},</span>
</span></span><span class="line"><span class="cl">		<span class="nx">ExposedHeaders</span><span class="p">:</span>   <span class="p">[]</span><span class="kt">string</span><span class="p">{</span><span class="s">&#34;Accept&#34;</span><span class="p">,</span> <span class="s">&#34;Content-Type&#34;</span><span class="p">,</span> <span class="s">&#34;Content-Length&#34;</span><span class="p">,</span> <span class="s">&#34;Accept-Encoding&#34;</span><span class="p">,</span> <span class="s">&#34;X-CSRF-Token&#34;</span><span class="p">,</span> <span class="s">&#34;Authorization&#34;</span><span class="p">},</span>
</span></span><span class="line"><span class="cl">		<span class="nx">AllowCredentials</span><span class="p">:</span> <span class="kc">true</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">	<span class="p">})</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><pre><code>- jwt.go // token 认证
</code></pre>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="kn">package</span> <span class="nx">middleware</span>
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="p">(</span>
</span></span><span class="line"><span class="cl">	<span class="s">&#34;github.com/iris-contrib/middleware/jwt&#34;</span>
</span></span><span class="line"><span class="cl"><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="cm">/**
</span></span></span><span class="line"><span class="cl"><span class="cm"> * 验证 jwt
</span></span></span><span class="line"><span class="cl"><span class="cm"> * @method JwtHandler
</span></span></span><span class="line"><span class="cl"><span class="cm"> */</span>
</span></span><span class="line"><span class="cl"><span class="kd">func</span> <span class="nf">JwtHandler</span><span class="p">()</span> <span class="o">*</span><span class="nx">jwt</span><span class="p">.</span><span class="nx">Middleware</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="kd">var</span> <span class="nx">mySecret</span> <span class="p">=</span> <span class="p">[]</span><span class="nb">byte</span><span class="p">(</span><span class="s">&#34;HS2JDFKhu7Y1av7b&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="k">return</span> <span class="nx">jwt</span><span class="p">.</span><span class="nf">New</span><span class="p">(</span><span class="nx">jwt</span><span class="p">.</span><span class="nx">Config</span><span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="nx">ValidationKeyGetter</span><span class="p">:</span> <span class="kd">func</span><span class="p">(</span><span class="nx">token</span> <span class="o">*</span><span class="nx">jwt</span><span class="p">.</span><span class="nx">Token</span><span class="p">)</span> <span class="p">(</span><span class="kd">interface</span><span class="p">{},</span> <span class="kt">error</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">			<span class="k">return</span> <span class="nx">mySecret</span><span class="p">,</span> <span class="kc">nil</span>
</span></span><span class="line"><span class="cl">		<span class="p">},</span>
</span></span><span class="line"><span class="cl">		<span class="nx">SigningMethod</span><span class="p">:</span> <span class="nx">jwt</span><span class="p">.</span><span class="nx">SigningMethodHS256</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">	<span class="p">})</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><ul>
<li>models // 模型
<ul>
<li>base.go  // 初始化数据库，公共方法</li>
</ul>
</li>
</ul>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="kn">package</span> <span class="nx">models</span>
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="p">(</span>
</span></span><span class="line"><span class="cl">	<span class="s">&#34;errors&#34;</span>
</span></span><span class="line"><span class="cl">	<span class="s">&#34;fmt&#34;</span>
</span></span><span class="line"><span class="cl">	<span class="s">&#34;os&#34;</span>
</span></span><span class="line"><span class="cl">	<span class="s">&#34;strings&#34;</span>
</span></span><span class="line"><span class="cl">	<span class="s">&#34;github.com/fatih/color&#34;</span>
</span></span><span class="line"><span class="cl">	<span class="s">&#34;github.com/jinzhu/gorm&#34;</span>
</span></span><span class="line"><span class="cl">	<span class="nx">_</span> <span class="s">&#34;github.com/jinzhu/gorm/dialects/mysql&#34;</span>
</span></span><span class="line"><span class="cl">	<span class="nx">_</span> <span class="s">&#34;github.com/mattn/go-sqlite3&#34;</span>
</span></span><span class="line"><span class="cl"><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="kd">var</span> <span class="nx">Db</span> <span class="o">*</span><span class="nx">gorm</span><span class="p">.</span><span class="nx">DB</span>
</span></span><span class="line"><span class="cl"><span class="kd">var</span> <span class="nx">err</span> <span class="kt">error</span>
</span></span><span class="line"><span class="cl"><span class="kd">var</span> <span class="nx">dirverName</span> <span class="kt">string</span>
</span></span><span class="line"><span class="cl"><span class="kd">var</span> <span class="nx">conn</span> <span class="kt">string</span>
</span></span><span class="line"><span class="cl"><span class="cm">/**
</span></span></span><span class="line"><span class="cl"><span class="cm">*设置数据库连接
</span></span></span><span class="line"><span class="cl"><span class="cm">*@param diver string
</span></span></span><span class="line"><span class="cl"><span class="cm"> */</span>
</span></span><span class="line"><span class="cl"><span class="kd">func</span> <span class="nf">Register</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="nx">dirverName</span> <span class="p">=</span> <span class="s">&#34;mysql&#34;</span>
</span></span><span class="line"><span class="cl">	<span class="k">if</span> <span class="nf">isTestEnv</span><span class="p">()</span> <span class="p">{</span> <span class="c1">//如果是测试使用测试数据库
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>		<span class="nx">conn</span> <span class="p">=</span> <span class="s">&#34;root:wemT5ZNuo074i4FNsTwl4KhfVSvOlBcF@(127.0.0.1:3306)/tiris?charset=utf8&amp;parseTime=True&amp;loc=Local&#34;</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="nx">conn</span> <span class="p">=</span> <span class="s">&#34;root:wemT5ZNuo074i4FNsTwl4KhfVSvOlBcF@(127.0.0.1:3306)/iris?charset=utf8&amp;parseTime=True&amp;loc=Local&#34;</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">	<span class="c1">//初始化数据库
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="nx">Db</span><span class="p">,</span> <span class="nx">err</span> <span class="p">=</span> <span class="nx">gorm</span><span class="p">.</span><span class="nf">Open</span><span class="p">(</span><span class="nx">dirverName</span><span class="p">,</span> <span class="nx">conn</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="nx">color</span><span class="p">.</span><span class="nf">Red</span><span class="p">(</span><span class="nx">fmt</span><span class="p">.</span><span class="nf">Sprintf</span><span class="p">(</span><span class="s">&#34;gorm open 错误: %v&#34;</span><span class="p">,</span> <span class="nx">err</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="kd">func</span> <span class="nf">IsNotFound</span><span class="p">(</span><span class="nx">err</span> <span class="kt">error</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="k">if</span> <span class="nx">ok</span> <span class="o">:=</span> <span class="nx">errors</span><span class="p">.</span><span class="nf">Is</span><span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">gorm</span><span class="p">.</span><span class="nx">ErrRecordNotFound</span><span class="p">);</span> <span class="p">!</span><span class="nx">ok</span> <span class="o">&amp;&amp;</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="nx">color</span><span class="p">.</span><span class="nf">Red</span><span class="p">(</span><span class="nx">fmt</span><span class="p">.</span><span class="nf">Sprintf</span><span class="p">(</span><span class="s">&#34;error :%v \n &#34;</span><span class="p">,</span> <span class="nx">err</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="c1">//获取程序运行环境
</span></span></span><span class="line"><span class="cl"><span class="c1">// 根据程序运行路径后缀判断
</span></span></span><span class="line"><span class="cl"><span class="c1">//如果是 test 就是测试环境
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kd">func</span> <span class="nf">isTestEnv</span><span class="p">()</span> <span class="kt">bool</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="nx">files</span> <span class="o">:=</span> <span class="nx">os</span><span class="p">.</span><span class="nx">Args</span>
</span></span><span class="line"><span class="cl">	<span class="k">for</span> <span class="nx">_</span><span class="p">,</span> <span class="nx">v</span> <span class="o">:=</span> <span class="k">range</span> <span class="nx">files</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="k">if</span> <span class="nx">strings</span><span class="p">.</span><span class="nf">Contains</span><span class="p">(</span><span class="nx">v</span><span class="p">,</span> <span class="s">&#34;test&#34;</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">			<span class="k">return</span> <span class="kc">true</span>
</span></span><span class="line"><span class="cl">		<span class="p">}</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">	<span class="k">return</span> <span class="kc">false</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="c1">// 接口返回数据对想
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kd">type</span> <span class="nx">Response</span> <span class="kd">struct</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="nx">Status</span> <span class="kt">bool</span>        <span class="s">`json:&#34;status&#34;`</span> <span class="c1">//接口状态 true ,false
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="nx">Msg</span>    <span class="kd">interface</span><span class="p">{}</span> <span class="s">`json:&#34;msg&#34;`</span>    <span class="c1">// 接口信息
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="nx">Data</span>   <span class="kd">interface</span><span class="p">{}</span> <span class="s">`json:&#34;data&#34;`</span>   <span class="c1">//接口数据
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="p">}</span>
</span></span></code></pre></div><ul>
<li>token.go // token模型</li>
</ul>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="kn">package</span> <span class="nx">models</span>
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="s">&#34;github.com/jinzhu/gorm&#34;</span>
</span></span><span class="line"><span class="cl"><span class="c1">// token 数据模型
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kd">type</span> <span class="nx">OauthToken</span> <span class="kd">struct</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="nx">gorm</span><span class="p">.</span><span class="nx">Model</span>
</span></span><span class="line"><span class="cl">	<span class="nx">Token</span>     <span class="kt">string</span> <span class="s">`gorm:&#34;not null default &#39;&#39; comment(&#39;Token&#39;) VARCHAR(191)&#34;`</span>
</span></span><span class="line"><span class="cl">	<span class="nx">UserId</span>    <span class="kt">uint</span>   <span class="s">`gorm:&#34;not null default &#39;&#39; comment(&#39;UserId&#39;) VARCHAR(191)&#34;`</span>
</span></span><span class="line"><span class="cl">	<span class="nx">Secret</span>    <span class="kt">string</span> <span class="s">`gorm:&#34;not null default &#39;&#39; comment(&#39;Secret&#39;) VARCHAR(191)&#34;`</span>
</span></span><span class="line"><span class="cl">	<span class="nx">ExpressIn</span> <span class="kt">int64</span>  <span class="s">`gorm:&#34;not null default 0 comment(&#39;是否是标准库&#39;) BIGINT(20)&#34;`</span>
</span></span><span class="line"><span class="cl">	<span class="nx">Revoked</span>   <span class="kt">bool</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="c1">// 创建 token
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kd">func</span> <span class="p">(</span><span class="nx">ot</span> <span class="o">*</span><span class="nx">OauthToken</span><span class="p">)</span> <span class="nf">OauthTokenCreate</span><span class="p">()</span> <span class="p">(</span><span class="nx">response</span> <span class="nx">Token</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="nx">Db</span><span class="p">.</span><span class="nf">Create</span><span class="p">(</span><span class="nx">ot</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="nx">response</span> <span class="p">=</span> <span class="nx">Token</span><span class="p">{</span><span class="nx">ot</span><span class="p">.</span><span class="nx">Token</span><span class="p">}</span>
</span></span><span class="line"><span class="cl">	<span class="k">return</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="kd">type</span> <span class="nx">Token</span> <span class="kd">struct</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="nx">Token</span> <span class="kt">string</span> <span class="s">`json:&#34;access_token&#34;`</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="c1">// 获取 access_token 信息
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kd">func</span> <span class="nf">GetOauthTokenByToken</span><span class="p">(</span><span class="nx">token</span> <span class="kt">string</span><span class="p">)</span> <span class="p">(</span><span class="nx">ot</span> <span class="o">*</span><span class="nx">OauthToken</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="nx">ot</span> <span class="p">=</span> <span class="nb">new</span><span class="p">(</span><span class="nx">OauthToken</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="nx">Db</span><span class="p">.</span><span class="nf">Where</span><span class="p">(</span><span class="s">&#34;token =  ?&#34;</span><span class="p">,</span> <span class="nx">token</span><span class="p">).</span><span class="nf">First</span><span class="p">(</span><span class="o">&amp;</span><span class="nx">ot</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="k">return</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><ul>
<li>user.go // 用户模型</li>
</ul>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="kn">package</span> <span class="nx">models</span>
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="p">(</span>
</span></span><span class="line"><span class="cl">	<span class="s">&#34;time&#34;</span>
</span></span><span class="line"><span class="cl">	<span class="s">&#34;github.com/iris-contrib/middleware/jwt&#34;</span>
</span></span><span class="line"><span class="cl">	<span class="s">&#34;github.com/jameskeane/bcrypt&#34;</span>
</span></span><span class="line"><span class="cl">	<span class="s">&#34;github.com/jinzhu/gorm&#34;</span>
</span></span><span class="line"><span class="cl"><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="c1">// 用户数据模型
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kd">type</span> <span class="nx">User</span> <span class="kd">struct</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="nx">gorm</span><span class="p">.</span><span class="nx">Model</span>
</span></span><span class="line"><span class="cl">	<span class="nx">Name</span>     <span class="kt">string</span> <span class="s">`gorm:&#34;not null VARCHAR(191)&#34;`</span>
</span></span><span class="line"><span class="cl">	<span class="nx">Username</span> <span class="kt">string</span> <span class="s">`gorm:&#34;unique;VARCHAR(191)&#34;`</span>
</span></span><span class="line"><span class="cl">	<span class="nx">Password</span> <span class="kt">string</span> <span class="s">`gorm:&#34;not null VARCHAR(191)&#34;`</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="c1">// 根据用户名查询用户
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kd">func</span> <span class="nf">UserAdminCheckLogin</span><span class="p">(</span><span class="nx">username</span> <span class="kt">string</span><span class="p">)</span> <span class="o">*</span><span class="nx">User</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="nx">user</span> <span class="o">:=</span> <span class="nb">new</span><span class="p">(</span><span class="nx">User</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="nf">IsNotFound</span><span class="p">(</span><span class="nx">Db</span><span class="p">.</span><span class="nf">Where</span><span class="p">(</span><span class="s">&#34;username = ?&#34;</span><span class="p">,</span> <span class="nx">username</span><span class="p">).</span><span class="nf">First</span><span class="p">(</span><span class="nx">user</span><span class="p">).</span><span class="nx">Error</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="k">return</span> <span class="nx">user</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="c1">// 检查登陆用户，并生成登陆凭证 token
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kd">func</span> <span class="nf">CheckLogin</span><span class="p">(</span><span class="nx">username</span><span class="p">,</span> <span class="nx">password</span> <span class="kt">string</span><span class="p">)</span> <span class="p">(</span><span class="nx">response</span> <span class="nx">Token</span><span class="p">,</span> <span class="nx">status</span> <span class="kt">bool</span><span class="p">,</span> <span class="nx">msg</span> <span class="kt">string</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="nx">user</span> <span class="o">:=</span> <span class="nf">UserAdminCheckLogin</span><span class="p">(</span><span class="nx">username</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="k">if</span> <span class="nx">user</span><span class="p">.</span><span class="nx">ID</span> <span class="o">==</span> <span class="mi">0</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="nx">msg</span> <span class="p">=</span> <span class="s">&#34;用户不存在&#34;</span>
</span></span><span class="line"><span class="cl">		<span class="k">return</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="k">if</span> <span class="nx">ok</span> <span class="o">:=</span> <span class="nx">bcrypt</span><span class="p">.</span><span class="nf">Match</span><span class="p">(</span><span class="nx">password</span><span class="p">,</span> <span class="nx">user</span><span class="p">.</span><span class="nx">Password</span><span class="p">);</span> <span class="nx">ok</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">			<span class="nx">token</span> <span class="o">:=</span> <span class="nx">jwt</span><span class="p">.</span><span class="nf">NewTokenWithClaims</span><span class="p">(</span><span class="nx">jwt</span><span class="p">.</span><span class="nx">SigningMethodHS256</span><span class="p">,</span> <span class="nx">jwt</span><span class="p">.</span><span class="nx">MapClaims</span><span class="p">{</span>
</span></span><span class="line"><span class="cl">				<span class="s">&#34;exp&#34;</span><span class="p">:</span> <span class="nx">time</span><span class="p">.</span><span class="nf">Now</span><span class="p">().</span><span class="nf">Add</span><span class="p">(</span><span class="nx">time</span><span class="p">.</span><span class="nx">Hour</span> <span class="o">*</span> <span class="nx">time</span><span class="p">.</span><span class="nf">Duration</span><span class="p">(</span><span class="mi">1</span><span class="p">)).</span><span class="nf">Unix</span><span class="p">(),</span>
</span></span><span class="line"><span class="cl">				<span class="s">&#34;iat&#34;</span><span class="p">:</span> <span class="nx">time</span><span class="p">.</span><span class="nf">Now</span><span class="p">().</span><span class="nf">Unix</span><span class="p">(),</span>
</span></span><span class="line"><span class="cl">			<span class="p">})</span>
</span></span><span class="line"><span class="cl">			<span class="nx">tokenString</span><span class="p">,</span> <span class="nx">_</span> <span class="o">:=</span> <span class="nx">token</span><span class="p">.</span><span class="nf">SignedString</span><span class="p">([]</span><span class="nb">byte</span><span class="p">(</span><span class="s">&#34;HS2JDFKhu7Y1av7b&#34;</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">			<span class="nx">oauthToken</span> <span class="o">:=</span> <span class="nb">new</span><span class="p">(</span><span class="nx">OauthToken</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">			<span class="nx">oauthToken</span><span class="p">.</span><span class="nx">Token</span> <span class="p">=</span> <span class="nx">tokenString</span>
</span></span><span class="line"><span class="cl">			<span class="nx">oauthToken</span><span class="p">.</span><span class="nx">UserId</span> <span class="p">=</span> <span class="nx">user</span><span class="p">.</span><span class="nx">ID</span>
</span></span><span class="line"><span class="cl">			<span class="nx">oauthToken</span><span class="p">.</span><span class="nx">Secret</span> <span class="p">=</span> <span class="s">&#34;secret&#34;</span>
</span></span><span class="line"><span class="cl">			<span class="nx">oauthToken</span><span class="p">.</span><span class="nx">Revoked</span> <span class="p">=</span> <span class="kc">false</span>
</span></span><span class="line"><span class="cl">			<span class="nx">oauthToken</span><span class="p">.</span><span class="nx">ExpressIn</span> <span class="p">=</span> <span class="nx">time</span><span class="p">.</span><span class="nf">Now</span><span class="p">().</span><span class="nf">Add</span><span class="p">(</span><span class="nx">time</span><span class="p">.</span><span class="nx">Hour</span> <span class="o">*</span> <span class="nx">time</span><span class="p">.</span><span class="nf">Duration</span><span class="p">(</span><span class="mi">1</span><span class="p">)).</span><span class="nf">Unix</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">			<span class="nx">oauthToken</span><span class="p">.</span><span class="nx">CreatedAt</span> <span class="p">=</span> <span class="nx">time</span><span class="p">.</span><span class="nf">Now</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">			<span class="nx">response</span> <span class="p">=</span> <span class="nx">oauthToken</span><span class="p">.</span><span class="nf">OauthTokenCreate</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">			<span class="nx">status</span> <span class="p">=</span> <span class="kc">true</span>
</span></span><span class="line"><span class="cl">			<span class="nx">msg</span> <span class="p">=</span> <span class="s">&#34;登陆成功&#34;</span>
</span></span><span class="line"><span class="cl">			<span class="k">return</span>
</span></span><span class="line"><span class="cl">		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">			<span class="nx">msg</span> <span class="p">=</span> <span class="s">&#34;用户名或密码错误&#34;</span>
</span></span><span class="line"><span class="cl">			<span class="k">return</span>
</span></span><span class="line"><span class="cl">		<span class="p">}</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="c1">// 作废token
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kd">func</span> <span class="nf">UpdateOauthTokenByUserId</span><span class="p">(</span><span class="nx">userId</span> <span class="kt">uint</span><span class="p">)</span> <span class="p">(</span><span class="nx">ot</span> <span class="o">*</span><span class="nx">OauthToken</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="nx">Db</span><span class="p">.</span><span class="nf">Model</span><span class="p">(</span><span class="nx">ot</span><span class="p">).</span><span class="nf">Where</span><span class="p">(</span><span class="s">&#34;revoked = ?&#34;</span><span class="p">,</span> <span class="kc">false</span><span class="p">).</span>
</span></span><span class="line"><span class="cl">		<span class="nf">Where</span><span class="p">(</span><span class="s">&#34;user_id = ?&#34;</span><span class="p">,</span> <span class="nx">userId</span><span class="p">).</span>
</span></span><span class="line"><span class="cl">		<span class="nf">Updates</span><span class="p">(</span><span class="kd">map</span><span class="p">[</span><span class="kt">string</span><span class="p">]</span><span class="kd">interface</span><span class="p">{}{</span><span class="s">&#34;revoked&#34;</span><span class="p">:</span> <span class="kc">true</span><span class="p">})</span>
</span></span><span class="line"><span class="cl">	<span class="k">return</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="c1">// 登出用户
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kd">func</span> <span class="nf">UserAdminLogout</span><span class="p">(</span><span class="nx">userId</span> <span class="kt">uint</span><span class="p">)</span> <span class="kt">bool</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="nx">ot</span> <span class="o">:=</span> <span class="nf">UpdateOauthTokenByUserId</span><span class="p">(</span><span class="nx">userId</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="k">return</span> <span class="nx">ot</span><span class="p">.</span><span class="nx">Revoked</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><ul>
<li>routers // 路由
<ul>
<li>router.go</li>
</ul>
</li>
</ul>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="kn">package</span> <span class="nx">routers</span>
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="p">(</span>
</span></span><span class="line"><span class="cl">	<span class="s">&#34;IrisAdmin/controllers&#34;</span>
</span></span><span class="line"><span class="cl">	<span class="s">&#34;IrisAdmin/middleware&#34;</span>
</span></span><span class="line"><span class="cl">	<span class="s">&#34;github.com/kataras/iris/v12&#34;</span>
</span></span><span class="line"><span class="cl"><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="kd">func</span> <span class="nf">Register</span><span class="p">(</span><span class="nx">app</span> <span class="o">*</span><span class="nx">iris</span><span class="p">.</span><span class="nx">Application</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="c1">// 路由集使用跨域中间件 CrsAuth()
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="c1">// 允许 Options 方法 AllowMethods(iris.MethodOptions)
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="nx">main</span> <span class="o">:=</span> <span class="nx">app</span><span class="p">.</span><span class="nf">Party</span><span class="p">(</span><span class="s">&#34;/&#34;</span><span class="p">,</span> <span class="nx">middleware</span><span class="p">.</span><span class="nf">CrsAuth</span><span class="p">()).</span><span class="nf">AllowMethods</span><span class="p">(</span><span class="nx">iris</span><span class="p">.</span><span class="nx">MethodOptions</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="nx">v1</span> <span class="o">:=</span> <span class="nx">main</span><span class="p">.</span><span class="nf">Party</span><span class="p">(</span><span class="s">&#34;/v1&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">		<span class="p">{</span>
</span></span><span class="line"><span class="cl">			<span class="nx">v1</span><span class="p">.</span><span class="nf">Post</span><span class="p">(</span><span class="s">&#34;/admin/login&#34;</span><span class="p">,</span> <span class="nx">controllers</span><span class="p">.</span><span class="nx">UserLogin</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">			<span class="nx">v1</span><span class="p">.</span><span class="nf">PartyFunc</span><span class="p">(</span><span class="s">&#34;/admin&#34;</span><span class="p">,</span> <span class="kd">func</span><span class="p">(</span><span class="nx">admin</span> <span class="nx">iris</span><span class="p">.</span><span class="nx">Party</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">				<span class="nx">admin</span><span class="p">.</span><span class="nf">Use</span><span class="p">(</span><span class="nx">middleware</span><span class="p">.</span><span class="nf">JwtHandler</span><span class="p">().</span><span class="nx">Serve</span><span class="p">,</span> <span class="nx">middleware</span><span class="p">.</span><span class="nx">AuthToken</span><span class="p">)</span> <span class="c1">//登录验证
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>				<span class="nx">admin</span><span class="p">.</span><span class="nf">Get</span><span class="p">(</span><span class="s">&#34;/logout&#34;</span><span class="p">,</span>  <span class="nx">controllers</span><span class="p">.</span><span class="nx">UserLogout</span><span class="p">).</span><span class="nx">Name</span> <span class="p">=</span> <span class="s">&#34;退出&#34;</span>
</span></span><span class="line"><span class="cl">			<span class="p">})</span>
</span></span><span class="line"><span class="cl">		<span class="p">}</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><ul>
<li>auth_test.go // 单元测试</li>
</ul>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="kn">package</span> <span class="nx">main</span>
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="p">(</span>
</span></span><span class="line"><span class="cl">	<span class="s">&#34;testing&#34;</span>
</span></span><span class="line"><span class="cl">	<span class="s">&#34;github.com/kataras/iris/v12&#34;</span>
</span></span><span class="line"><span class="cl"><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="c1">//登陆成功
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kd">func</span> <span class="nf">TestUserLoginSuccess</span><span class="p">(</span><span class="nx">t</span> <span class="o">*</span><span class="nx">testing</span><span class="p">.</span><span class="nx">T</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="nx">oj</span> <span class="o">:=</span> <span class="kd">map</span><span class="p">[</span><span class="kt">string</span><span class="p">]</span><span class="kt">string</span><span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="s">&#34;username&#34;</span><span class="p">:</span> <span class="s">&#34;username&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">		<span class="s">&#34;password&#34;</span><span class="p">:</span> <span class="s">&#34;password&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">	<span class="nf">login</span><span class="p">(</span><span class="nx">t</span><span class="p">,</span> <span class="nx">oj</span><span class="p">,</span> <span class="nx">iris</span><span class="p">.</span><span class="nx">StatusOK</span><span class="p">,</span> <span class="kc">true</span><span class="p">,</span> <span class="s">&#34;登陆成功&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="c1">// 输入不存在的用户名登陆
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kd">func</span> <span class="nf">TestUserLoginWithErrorName</span><span class="p">(</span><span class="nx">t</span> <span class="o">*</span><span class="nx">testing</span><span class="p">.</span><span class="nx">T</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="nx">oj</span> <span class="o">:=</span> <span class="kd">map</span><span class="p">[</span><span class="kt">string</span><span class="p">]</span><span class="kt">string</span><span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="s">&#34;username&#34;</span><span class="p">:</span> <span class="s">&#34;err_user&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">		<span class="s">&#34;password&#34;</span><span class="p">:</span> <span class="s">&#34;password&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">	<span class="nf">login</span><span class="p">(</span><span class="nx">t</span><span class="p">,</span> <span class="nx">oj</span><span class="p">,</span> <span class="nx">iris</span><span class="p">.</span><span class="nx">StatusOK</span><span class="p">,</span> <span class="kc">false</span><span class="p">,</span> <span class="s">&#34;用户不存在&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="c1">// 输入错误的登陆密码
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kd">func</span> <span class="nf">TestUserLoginWithErrorPwd</span><span class="p">(</span><span class="nx">t</span> <span class="o">*</span><span class="nx">testing</span><span class="p">.</span><span class="nx">T</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="nx">oj</span> <span class="o">:=</span> <span class="kd">map</span><span class="p">[</span><span class="kt">string</span><span class="p">]</span><span class="kt">string</span><span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="s">&#34;username&#34;</span><span class="p">:</span> <span class="s">&#34;username&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">		<span class="s">&#34;password&#34;</span><span class="p">:</span> <span class="s">&#34;admin&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">	<span class="nf">login</span><span class="p">(</span><span class="nx">t</span><span class="p">,</span> <span class="nx">oj</span><span class="p">,</span> <span class="nx">iris</span><span class="p">.</span><span class="nx">StatusOK</span><span class="p">,</span> <span class="kc">false</span><span class="p">,</span> <span class="s">&#34;用户名或密码错误&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="c1">// 输入登陆密码格式错误
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kd">func</span> <span class="nf">TestUserLoginWithErrorFormtPwd</span><span class="p">(</span><span class="nx">t</span> <span class="o">*</span><span class="nx">testing</span><span class="p">.</span><span class="nx">T</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="nx">oj</span> <span class="o">:=</span> <span class="kd">map</span><span class="p">[</span><span class="kt">string</span><span class="p">]</span><span class="kt">string</span><span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="s">&#34;username&#34;</span><span class="p">:</span> <span class="s">&#34;username&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">		<span class="s">&#34;password&#34;</span><span class="p">:</span> <span class="s">&#34;123&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">	<span class="nf">login</span><span class="p">(</span><span class="nx">t</span><span class="p">,</span> <span class="nx">oj</span><span class="p">,</span> <span class="nx">iris</span><span class="p">.</span><span class="nx">StatusOK</span><span class="p">,</span> <span class="kc">false</span><span class="p">,</span> <span class="s">&#34;密码格式错误&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="c1">// 输入登陆密码格式错误
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kd">func</span> <span class="nf">TestUserLoginWithErrorFormtUserName</span><span class="p">(</span><span class="nx">t</span> <span class="o">*</span><span class="nx">testing</span><span class="p">.</span><span class="nx">T</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="nx">oj</span> <span class="o">:=</span> <span class="kd">map</span><span class="p">[</span><span class="kt">string</span><span class="p">]</span><span class="kt">string</span><span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="s">&#34;username&#34;</span><span class="p">:</span> <span class="s">&#34;df&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">		<span class="s">&#34;password&#34;</span><span class="p">:</span> <span class="s">&#34;123&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">	<span class="nf">login</span><span class="p">(</span><span class="nx">t</span><span class="p">,</span> <span class="nx">oj</span><span class="p">,</span> <span class="nx">iris</span><span class="p">.</span><span class="nx">StatusOK</span><span class="p">,</span> <span class="kc">false</span><span class="p">,</span> <span class="s">&#34;用户名格式错误&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><ul>
<li>base_test.go</li>
</ul>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="kn">package</span> <span class="nx">main</span>
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="p">(</span>
</span></span><span class="line"><span class="cl">	<span class="s">&#34;flag&#34;</span>
</span></span><span class="line"><span class="cl">	<span class="s">&#34;os&#34;</span>
</span></span><span class="line"><span class="cl">	<span class="s">&#34;testing&#34;</span>
</span></span><span class="line"><span class="cl">	<span class="s">&#34;github.com/gavv/httpexpect&#34;</span>
</span></span><span class="line"><span class="cl">	<span class="s">&#34;github.com/kataras/iris/v12&#34;</span>
</span></span><span class="line"><span class="cl">	<span class="s">&#34;github.com/kataras/iris/v12/httptest&#34;</span>
</span></span><span class="line"><span class="cl"><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="kd">const</span> <span class="nx">baseUrl</span> <span class="p">=</span> <span class="s">&#34;/v1/admin/&#34;</span> <span class="c1">// 接口地址
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kd">const</span> <span class="nx">loginUrl</span> <span class="p">=</span> <span class="nx">baseUrl</span> <span class="o">+</span> <span class="s">&#34;login&#34;</span> <span class="c1">// 登陆接口地址
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kd">var</span> <span class="p">(</span>
</span></span><span class="line"><span class="cl">	<span class="nx">app</span>   <span class="o">*</span><span class="nx">iris</span><span class="p">.</span><span class="nx">Application</span> 
</span></span><span class="line"><span class="cl"><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="c1">//单元测试基境
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kd">func</span> <span class="nf">TestMain</span><span class="p">(</span><span class="nx">m</span> <span class="o">*</span><span class="nx">testing</span><span class="p">.</span><span class="nx">M</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="c1">// 初始化app
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="nx">app</span> <span class="p">=</span> <span class="nf">NewApp</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">	<span class="nx">flag</span><span class="p">.</span><span class="nf">Parse</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">	<span class="nx">exitCode</span> <span class="o">:=</span> <span class="nx">m</span><span class="p">.</span><span class="nf">Run</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">	<span class="nx">os</span><span class="p">.</span><span class="nf">Exit</span><span class="p">(</span><span class="nx">exitCode</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="c1">// 单元测试 login 方法
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kd">func</span> <span class="nf">login</span><span class="p">(</span><span class="nx">t</span> <span class="o">*</span><span class="nx">testing</span><span class="p">.</span><span class="nx">T</span><span class="p">,</span> <span class="nx">Object</span> <span class="kd">interface</span><span class="p">{},</span> <span class="nx">StatusCode</span> <span class="kt">int</span><span class="p">,</span> <span class="nx">Status</span> <span class="kt">bool</span><span class="p">,</span> <span class="nx">Msg</span> <span class="kt">string</span><span class="p">)</span> <span class="p">(</span><span class="nx">e</span> <span class="o">*</span><span class="nx">httpexpect</span><span class="p">.</span><span class="nx">Expect</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="nx">e</span> <span class="p">=</span> <span class="nx">httptest</span><span class="p">.</span><span class="nf">New</span><span class="p">(</span><span class="nx">t</span><span class="p">,</span> <span class="nx">app</span><span class="p">,</span> <span class="nx">httptest</span><span class="p">.</span><span class="nx">Configuration</span><span class="p">{</span><span class="nx">Debug</span><span class="p">:</span> <span class="kc">true</span><span class="p">})</span>
</span></span><span class="line"><span class="cl">	<span class="nx">e</span><span class="p">.</span><span class="nf">POST</span><span class="p">(</span><span class="nx">loginUrl</span><span class="p">).</span><span class="nf">WithJSON</span><span class="p">(</span><span class="nx">Object</span><span class="p">).</span><span class="nf">Expect</span><span class="p">().</span><span class="nf">Status</span><span class="p">(</span><span class="nx">StatusCode</span><span class="p">).</span><span class="nf">JSON</span><span class="p">().</span><span class="nf">Object</span><span class="p">().</span><span class="nf">Values</span><span class="p">().</span><span class="nf">Contains</span><span class="p">(</span><span class="nx">Status</span><span class="p">,</span> <span class="nx">Msg</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="k">return</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><ul>
<li>main.go</li>
</ul>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="kn">package</span> <span class="nx">main</span>
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="p">(</span>
</span></span><span class="line"><span class="cl">	<span class="s">&#34;IrisAdmin/models&#34;</span>
</span></span><span class="line"><span class="cl">	<span class="s">&#34;IrisAdmin/routers&#34;</span>
</span></span><span class="line"><span class="cl">	<span class="s">&#34;github.com/kataras/iris/v12&#34;</span>
</span></span><span class="line"><span class="cl">	<span class="nx">_</span> <span class="s">&#34;github.com/jinzhu/gorm/dialects/mysql&#34;</span>
</span></span><span class="line"><span class="cl">	<span class="s">&#34;github.com/kataras/iris/v12/middleware/logger&#34;</span>
</span></span><span class="line"><span class="cl">	<span class="s">&#34;github.com/kataras/iris/v12/middleware/recover&#34;</span>
</span></span><span class="line"><span class="cl">	<span class="nx">_</span> <span class="s">&#34;github.com/mattn/go-sqlite3&#34;</span>
</span></span><span class="line"><span class="cl"><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="kd">func</span> <span class="nf">NewApp</span><span class="p">()</span> <span class="o">*</span><span class="nx">iris</span><span class="p">.</span><span class="nx">Application</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="nx">models</span><span class="p">.</span><span class="nf">Register</span><span class="p">()</span> <span class="c1">// 数据库初始化
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="nx">models</span><span class="p">.</span><span class="nx">Db</span><span class="p">.</span><span class="nf">AutoMigrate</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">		<span class="o">&amp;</span><span class="nx">models</span><span class="p">.</span><span class="nx">User</span><span class="p">{},</span>
</span></span><span class="line"><span class="cl">		<span class="o">&amp;</span><span class="nx">models</span><span class="p">.</span><span class="nx">OauthToken</span><span class="p">{},</span>
</span></span><span class="line"><span class="cl">	<span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="nx">iris</span><span class="p">.</span><span class="nf">RegisterOnInterrupt</span><span class="p">(</span><span class="kd">func</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="nx">_</span> <span class="p">=</span> <span class="nx">models</span><span class="p">.</span><span class="nx">Db</span><span class="p">.</span><span class="nf">Close</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">	<span class="p">})</span>
</span></span><span class="line"><span class="cl">	<span class="nx">app</span> <span class="o">:=</span> <span class="nx">iris</span><span class="p">.</span><span class="nf">New</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">	<span class="nx">app</span><span class="p">.</span><span class="nf">Logger</span><span class="p">().</span><span class="nf">SetLevel</span><span class="p">(</span><span class="s">&#34;debug&#34;</span><span class="p">)</span> <span class="c1">//设置日志级别
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="nx">app</span><span class="p">.</span><span class="nf">Use</span><span class="p">(</span><span class="nx">recover</span><span class="p">.</span><span class="nf">New</span><span class="p">())</span>
</span></span><span class="line"><span class="cl">	<span class="nx">app</span><span class="p">.</span><span class="nf">Use</span><span class="p">(</span><span class="nx">logger</span><span class="p">.</span><span class="nf">New</span><span class="p">())</span>
</span></span><span class="line"><span class="cl">	<span class="nx">routers</span><span class="p">.</span><span class="nf">Register</span><span class="p">(</span><span class="nx">app</span><span class="p">)</span> <span class="c1">// 注册路由
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="k">return</span> <span class="nx">app</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="kd">func</span> <span class="nf">main</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="nx">app</span> <span class="o">:=</span> <span class="nf">NewApp</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">	<span class="nx">app</span><span class="p">.</span><span class="nf">Run</span><span class="p">(</span><span class="nx">iris</span><span class="p">.</span><span class="nf">Addr</span><span class="p">(</span><span class="s">&#34;:8080&#34;</span><span class="p">),</span> <span class="nx">iris</span><span class="p">.</span><span class="nf">WithoutServerError</span><span class="p">(</span><span class="nx">iris</span><span class="p">.</span><span class="nx">ErrServerClosed</span><span class="p">))</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><p><img alt="image.png" src="/posts/iris-go-api-1/20x4VhKvaP.png"></p>
<ul>
<li>到此，登陆的接口基本完成。</li>
<li>但是还有很多问题没有解决，比如重复启动项目或者执行测试会得到如下提示，虽然测试还是通过，却会同时有一个报错。</li>
<li>原因是 <code>main.go</code> 中  <code>models.CreateUser()</code> 方法每次启动，测试都会重复执行。但是数据已经有的数据虽有会报错，数据已经存在的错误。</li>
<li>要解决的方法也很简单，直接注释  <code>models.CreateUser()</code> 方法即可。</li>
<li>同时还有更好的解决方法，判断数据库是否存在数据，如果存在就不保存新数据。</li>
<li>单元测试则可以在每次单元测试后摧毁数据，这样可以防止多个单元测试的数据相互污染，导致测试结果和预期结果不符合。
<img alt="image.png" src="/posts/iris-go-api-1/q58tGNCpL0.png"></li>
</ul></div>
    <div class="post__footer">
      
        <span><a class="category" href="/categories/golang/">Golang</a><a class="category" href="/categories/iris/">IRIS</a></span>


      

      
        <span><a class="tag" href="/tags/golang/">Golang</a><a class="tag" href="/tags/iris/">IRIS</a><a class="tag" href="/tags/api/">Api</a></span>


      
    </div>

    
  </div>

      </main>
    </div><footer class="footer footer__base">
  <ul class="footer__list">
    <li class="footer__item">
      &copy;
      
        Snowlyg 2020-2021
      
    </li>
    
  </ul>
</footer>
  
  <script
    type="text/javascript"
    src="/js/medium-zoom.min.1248fa75275e5ef0cbef27e8c1e27dc507c445ae3a2c7d2ed0be0809555dac64.js"
    integrity="sha256-Ekj6dSdeXvDL7yfoweJ9xQfERa46LH0u0L4ICVVdrGQ="
    crossorigin="anonymous"
  ></script></body>
</html>
